<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Block Clicker Game</title>
    <!-- Favicon -->
    <link rel="icon" href="mouse-cursor.png" type="image/png">
    <!-- Google AdSense code - Replace with your actual AdSense code after approval -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3727712535529004" crossorigin="anonymous"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- External CSS file -->
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Add these styles to the head of the document or to styles.css */
        .build-slots {
            margin-bottom: 15px;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .build-slots-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .slot-actions {
            display: flex;
            gap: 5px;
        }

        .build-slots-header h3 {
            margin: 0;
            font-size: 1rem;
            color: #eee;
        }

        .build-slots-container {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .build-slot {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            min-width: 60px;
            text-align: center;
        }

        .build-slot.active {
            background-color: rgba(70, 130, 255, 0.5);
            border-color: rgba(70, 130, 255, 0.8);
            box-shadow: 0 0 12px rgba(70, 130, 255, 0.5);
        }

        .build-slot:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .build-slot.active:hover {
            background-color: rgba(70, 130, 255, 0.6);
        }

        .slot-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
        }

        .rename-slot-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .rename-slot-content {
            background-color: #333;
            border-radius: 8px;
            padding: 20px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        .rename-slot-content h3 {
            margin-top: 0;
            color: #eee;
        }

        .rename-slot-content input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            background-color: #222;
            border: 1px solid #444;
            color: #eee;
            border-radius: 4px;
        }

        .rename-slot-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }

        .rename-slot-buttons button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .rename-cancel {
            background-color: #555;
            color: #eee;
        }

        .rename-confirm {
            background-color: #4682ff;
            color: white;
        }

        .slot-delete {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 18px;
            height: 18px;
            background-color: #ff3333;
            border-radius: 50%;
            display: none;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 10px;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            z-index: 5;
        }

        .slot-delete:hover {
            background-color: #ff0000;
            transform: scale(1.1);
        }

        /* Settings Panel Styles */
        .settings-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 0 auto;
            max-width: 1200px;
            padding: 20px;
        }

        .settings-group {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .settings-group h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #eee;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .settings-group h3 i {
            color: #4682ff;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .setting-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .setting-item label {
            color: #ddd;
            font-size: 1rem;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #666;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #4682ff;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        /* Dropdown and Slider Styles */
        .settings-select {
            background-color: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #eee;
            padding: 8px 12px;
            border-radius: 5px;
            min-width: 150px;
            font-size: 0.9rem;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 180px;
        }

        .settings-slider {
            -webkit-appearance: none;
            width: 130px;
            height: 5px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            outline: none;
        }

        .settings-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 15px;
            height: 15px;
            background: #4682ff;
            border-radius: 50%;
            cursor: pointer;
        }

        .volume-value {
            color: #ddd;
            font-size: 0.9rem;
            min-width: 40px;
            text-align: right;
        }

        /* Settings Actions */
        .settings-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 20px;
            margin-right: 20px;
        }

        .settings-btn {
            background: rgba(0, 0, 0, 0.3);
            color: #ddd;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Montserrat', sans-serif;
        }

        .settings-btn:hover {
            background: rgba(0, 0, 0, 0.5);
        }

        .settings-btn-primary {
            background: #4682ff;
            color: white;
            border: none;
        }

        .settings-btn-primary:hover {
            background: #3571e8;
        }

        /* Themes */
        .theme-dark {
            --bg-color: #121212;
            --text-color: #eaeaea;
            --accent-color: #4682ff;
        }

        .theme-neon {
            --bg-color: #0f0f1b;
            --text-color: #00ffaa;
            --accent-color: #ff00ff;
        }

        .theme-retro {
            --bg-color: #2a2a2a;
            --text-color: #ffd700;
            --accent-color: #ff6347;
        }

        /* Apply theme variables to the actual elements */
        body {
            --default-bg-color: #1a1a2e;
            --default-text-color: #ffffff;
            --default-accent-color: #4682ff;
            
            background-color: var(--bg-color, var(--default-bg-color));
            color: var(--text-color, var(--default-text-color));
        }

        .sidebar, .settings-group, .builder-controls,
        .build-slots, .inventory, .shop-item {
            background-color: rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .theme-dark .sidebar, .theme-dark .settings-group,
        .theme-dark .builder-controls, .theme-dark .build-slots,
        .theme-dark .inventory, .theme-dark .shop-item {
            background-color: rgba(0, 0, 0, 0.5);
        }

        .theme-neon .sidebar, .theme-neon .settings-group,
        .theme-neon .builder-controls, .theme-neon .build-slots,
        .theme-neon .inventory, .theme-neon .shop-item {
            background-color: rgba(0, 0, 30, 0.4);
            border-color: var(--accent-color);
            box-shadow: 0 0 10px rgba(255, 0, 255, 0.2);
        }

        .theme-retro .sidebar, .theme-retro .settings-group,
        .theme-retro .builder-controls, .theme-retro .build-slots,
        .theme-retro .inventory, .theme-retro .shop-item {
            background-color: #333;
            border: 2px solid var(--accent-color);
        }

        h1, h2, h3, .section-title {
            color: var(--text-color, var(--default-text-color));
        }

        .theme-neon h1, .theme-neon h2, .theme-neon h3, 
        .theme-neon .section-title, .theme-neon .menu-item.active {
            color: var(--accent-color);
            text-shadow: 0 0 5px var(--accent-color), 0 0 10px var(--accent-color);
        }

        .theme-retro h1, .theme-retro h2, .theme-retro h3, 
        .theme-retro .section-title {
            color: var(--accent-color);
            font-family: 'Courier New', monospace;
        }

        .settings-btn-primary, input:checked + .toggle-slider,
        .settings-slider::-webkit-slider-thumb {
            background-color: var(--accent-color, var(--default-accent-color));
        }

        .menu-item.active {
            background-color: var(--accent-color, var(--default-accent-color));
        }

        .theme-neon .particle {
            background-color: var(--accent-color);
            box-shadow: 0 0 5px var(--accent-color), 0 0 10px var(--accent-color);
        }

        /* Accessibility Styles */
        .text-large {
            font-size: 1.2em;
        }

        .text-xl {
            font-size: 1.4em;
        }
        
        /* Make text size apply to all relevant elements */
        .text-large p, .text-large button, .text-large label, 
        .text-large .setting-item, .text-large .build-slot,
        .text-large .menu-item, .text-large .inventory-block,
        .text-large .shop-item-info {
            font-size: 1.1em;
        }
        
        .text-large h1 {
            font-size: 2.2em;
        }
        
        .text-large h2 {
            font-size: 1.8em;
        }
        
        .text-large h3 {
            font-size: 1.4em;
        }
        
        .text-xl p, .text-xl button, .text-xl label, 
        .text-xl .setting-item, .text-xl .build-slot,
        .text-xl .menu-item, .text-xl .inventory-block,
        .text-xl .shop-item-info {
            font-size: 1.3em;
        }
        
        .text-xl h1 {
            font-size: 2.6em;
        }
        
        .text-xl h2 {
            font-size: 2.2em;
        }
        
        .text-xl h3 {
            font-size: 1.8em;
        }

        .high-contrast {
            --bg-color: #000000;
            --text-color: #ffffff;
            --accent-color: #ffff00;
        }
        
        /* High Contrast specific overrides */
        .high-contrast .sidebar,
        .high-contrast .settings-group,
        .high-contrast .builder-controls,
        .high-contrast .build-slots,
        .high-contrast .inventory,
        .high-contrast .shop-item,
        .high-contrast .build-slot {
            background-color: black;
            border: 2px solid white;
        }
        
        .high-contrast .menu-item.active {
            background-color: yellow;
            color: black;
        }
        
        .high-contrast .grid-cell {
            border-color: white;
        }
        
        .high-contrast .build-slot.active {
            background-color: yellow;
            color: black;
        }
        
        .high-contrast .toggle-slider {
            background-color: #333;
        }
        
        .high-contrast input:checked + .toggle-slider {
            background-color: yellow;
        }
        
        .high-contrast .setting-item label {
            color: white;
        }

        .reduce-motion * {
            transition: none !important;
            animation: none !important;
        }
        
        .reduce-motion .auto-save-indicator,
        .reduce-motion .settings-confirmation,
        .reduce-motion .block-effect,
        .reduce-motion .score-effect,
        .reduce-motion .coin-effect {
            animation: none !important;
            transition: none !important;
            opacity: 1;
        }
        
        .reduce-motion .click-ripple {
            display: none;
        }

        /* Auto-save indicator */
        .auto-save-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: #4682ff;
            padding: 12px 20px;
            border-radius: 5px;
            font-size: 0.9rem;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: fadeIn 0.3s, fadeOut 0.3s 1.7s;
        }

        .settings-confirmation {
            background: rgba(70, 130, 255, 0.2);
            color: #4682ff;
            padding: 8px 15px;
            border-radius: 4px;
            margin-right: 15px;
        }

        /* Data Management Styles */
        .data-management-info p {
            font-size: 0.9rem;
            color: #bbb;
            margin: 0;
            font-style: italic;
        }

        .import-export-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .import-export-content {
            background-color: #333;
            border-radius: 8px;
            padding: 20px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        .import-export-content h3 {
            margin-top: 0;
            color: #eee;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .import-export-content textarea {
            width: 100%;
            height: 120px;
            padding: 10px;
            margin: 10px 0;
            background-color: #222;
            border: 1px solid #444;
            color: #eee;
            border-radius: 4px;
            font-family: monospace;
            resize: none;
        }

        .import-export-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }

        .copy-hint {
            display: none;
            font-size: 0.8rem;
            color: #4682ff;
            margin-top: 5px;
        }

        .import-alert {
            background-color: rgba(255, 100, 100, 0.2);
            border-radius: 4px;
            padding: 8px 10px;
            color: #ff6464;
            margin: 10px 0;
            display: none;
        }

        /* Update Log Styles */
        .update-log-container {
            max-height: 600px;
            overflow-y: auto;
            padding-right: 10px;
            margin: 0 auto;
            max-width: 800px;
        }

        .update-version {
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid var(--accent-color, #4682ff);
        }

        .version-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 10px;
        }

        .version-number {
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--accent-color, #4682ff);
            font-family: 'Orbitron', sans-serif;
        }

        .version-date {
            color: #aaa;
            font-style: italic;
            font-size: 0.9rem;
        }

        .version-changes ul {
            margin: 0;
            padding-left: 20px;
        }

        .version-changes li {
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .version-changes li:last-child {
            margin-bottom: 0;
        }

        .theme-neon .update-version {
            box-shadow: 0 0 10px rgba(255, 0, 255, 0.2);
        }

        .theme-retro .version-number {
            font-family: 'Courier New', monospace;
        }

        .high-contrast .update-version {
            background-color: black;
            border: 2px solid white;
            border-left: 4px solid yellow;
        }

        .high-contrast .version-number {
            color: yellow;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        .coming-soon-badge {
            position: absolute;
            right: 1rem;
            background: var(--accent-color, rgba(255, 255, 255, 0.2));
            color: #ddd;
            font-size: 0.6rem;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .update-new-badge {
            position: absolute;
            right: 1rem;
            background: #ff3e3e;
            color: white;
            font-size: 0.7rem;
            font-weight: bold;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            text-transform: uppercase;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Bonus indicator animation */
        .bonus-indicator {
            position: fixed;
            color: gold;
            font-size: 1.5rem;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.7);
            pointer-events: none;
            animation: bonus-float 1s ease-out forwards;
            z-index: 1000;
        }

        @keyframes bonus-float {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-50px); opacity: 0; }
        }

        /* Build reward effect */
        .build-reward {
            color: #32cd32;
            font-weight: bold;
            text-shadow: 0 0 8px rgba(50, 205, 50, 0.7);
            animation: build-reward-float 1.5s ease-out forwards;
        }

        .build-reward i {
            margin-right: 5px;
        }

        @keyframes build-reward-float {
            0% { transform: translateY(0) scale(0.8); opacity: 0; }
            20% { transform: translateY(-5px) scale(1.2); opacity: 1; }
            80% { transform: translateY(-30px) scale(1); opacity: 1; }
            100% { transform: translateY(-40px) scale(0.8); opacity: 0; }
        }
        
        /* Tutorial tip */
        .tutorial-tip {
            position: fixed;
            bottom: 30px;
            left: 30px;
            background-color: rgba(70, 130, 255, 0.95);
            border-radius: 8px;
            padding: 15px;
            display: flex;
            max-width: 350px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            color: white;
            z-index: 1000;
            animation: tipfadein 0.5s ease-out;
        }
        
        .tutorial-tip i {
            font-size: 24px;
            margin-right: 15px;
            color: yellow;
            align-self: center;
        }
        
        .tip-content {
            flex: 1;
        }
        
        .tip-content h4 {
            margin: 0 0 8px 0;
            font-size: 1.1rem;
        }
        
        .tip-content p {
            margin: 0 0 10px 0;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .close-tip {
            background-color: rgba(255, 255, 255, 0.3);
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background-color 0.2s;
        }
        
        .close-tip:hover {
            background-color: rgba(255, 255, 255, 0.5);
        }
        
        .tip-fadeout {
            animation: tipfadeout 0.5s forwards;
        }
        
        @keyframes tipfadein {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes tipfadeout {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(20px); }
        }

        /* Achievements Styles */
        .achievements-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .achievements-summary {
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .achievement-stats {
            display: flex;
            gap: 20px;
        }

        .achievement-stat {
            font-size: 1.1rem;
        }

        .stat-label {
            color: #aaa;
            margin-right: 8px;
        }

        .stat-value {
            color: var(--accent-color, #4682ff);
            font-weight: bold;
        }

        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .achievement-card {
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .achievement-card.locked {
            filter: grayscale(100%);
            opacity: 0.7;
        }

        .achievement-card.locked .achievement-name,
        .achievement-card.locked .achievement-description {
            filter: blur(3px);
        }

        .achievement-card.locked::after {
            content: "🔒";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            z-index: 2;
        }

        .achievement-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 12px;
        }

        .achievement-icon {
            width: 40px;
            height: 40px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--accent-color, #4682ff);
            font-size: 1.2rem;
        }

        .achievement-name {
            font-weight: bold;
            font-size: 1.1rem;
            color: #eee;
        }

        .achievement-description {
            color: #bbb;
            margin-bottom: 10px;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .achievement-progress-container {
            height: 5px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .achievement-progress {
            height: 100%;
            background-color: var(--accent-color, #4682ff);
            width: 0%; /* Will be set dynamically */
            transition: width 0.5s ease;
        }

        .achievement-completed {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: var(--accent-color, #4682ff);
            color: white;
            font-size: 0.7rem;
            font-weight: bold;
            padding: 3px 8px;
            border-radius: 10px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .achievement-card.unlocked .achievement-completed {
            opacity: 1;
        }

        .achievement-notification {
            position: fixed;
            bottom: 30px;
            right: -300px;
            width: 280px;
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            border-left: 4px solid var(--accent-color, #4682ff);
            z-index: 1000;
            animation: achievementSlideIn 0.5s forwards, achievementSlideOut 0.5s 4.5s forwards;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .achievement-notification-icon {
            font-size: 2rem;
            color: var(--accent-color, #4682ff);
        }

        .achievement-notification-content h4 {
            margin: 0 0 5px 0;
            font-size: 1rem;
        }

        .achievement-notification-content p {
            margin: 0;
            font-size: 0.8rem;
            color: #bbb;
        }

        @keyframes achievementSlideIn {
            from { right: -300px; }
            to { right: 30px; }
        }

        @keyframes achievementSlideOut {
            from { right: 30px; opacity: 1; }
            to { right: -300px; opacity: 0; }
        }

        /* Themes compatibility */
        .theme-neon .achievement-icon {
            text-shadow: 0 0 10px var(--accent-color, #ff00ff);
        }

        .theme-retro .achievement-card {
            border: 2px dashed var(--accent-color, #ff6347);
        }

        .high-contrast .achievement-card {
            background-color: black;
            border: 2px solid white;
        }

        .high-contrast .achievement-icon {
            background-color: white;
            color: black;
        }

        /* Shop item affordability indicator */
        .shop-item-price {
            transition: color 0.3s ease;
        }
        
        .shop-item-price.can-afford {
            color: #32cd32; /* Bright green */
        }
        
        .shop-item-price.can-afford i {
            color: #32cd32;
            animation: coin-pulse 1.5s infinite;
        }
        
        @keyframes coin-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); }
            100% { transform: scale(1); }
        }

        /* Profile Page Styles */
        .profile-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 1rem;
        }

        .profile-header {
            display: flex;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            gap: 1.5rem;
            position: relative;
        }

        .profile-avatar {
            position: relative;
            width: 100px;
            height: 100px;
        }

        .avatar-image {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 3px solid var(--accent-color, #4682ff);
        }

        .avatar-image i {
            font-size: 70px;
            color: var(--accent-color, #4682ff);
        }

        .change-avatar-btn {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--accent-color, #4682ff);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            transition: all 0.2s ease;
        }

        .change-avatar-btn:hover {
            transform: scale(1.1);
            background-color: #3569cc;
        }

        .profile-info {
            flex: 1;
        }

        .profile-name {
            font-size: 2rem;
            margin: 0 0 0.5rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .edit-name-btn {
            font-size: 1rem;
            color: #999;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .edit-name-btn:hover {
            color: var(--accent-color, #4682ff);
        }

        .profile-title {
            font-size: 1.2rem;
            color: var(--accent-color, #4682ff);
            font-style: italic;
        }

        .profile-level {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .level-badge {
            width: 45px;
            height: 45px;
            background-color: var(--accent-color, #4682ff);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
            box-shadow: 0 0 10px rgba(70, 130, 255, 0.5);
        }

        .level-progress-container {
            width: 100px;
            height: 6px;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 3px;
            overflow: hidden;
        }

        .level-progress {
            height: 100%;
            width: 25%;
            background-color: var(--accent-color, #4682ff);
            border-radius: 3px;
        }

        .level-text {
            font-size: 0.8rem;
            color: #bbb;
        }

        .profile-panels {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
        }

        .profile-panel {
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            overflow: hidden;
        }

        .panel-header {
            background-color: rgba(0, 0, 0, 0.3);
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .panel-header i {
            color: var(--accent-color, #4682ff);
            font-size: 1.2rem;
        }

        .panel-header h3 {
            margin: 0;
            font-size: 1.2rem;
        }

        .panel-content {
            padding: 1.5rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #bbb;
            margin-bottom: 0.3rem;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .achievement-progress-bar {
            height: 8px;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 1rem;
            position: relative;
        }

        .achievement-progress {
            height: 100%;
            width: 35%;
            background-color: var(--accent-color, #4682ff);
            border-radius: 4px;
        }

        .achievement-progress-text {
            position: absolute;
            top: 12px;
            right: 0;
            font-size: 0.85rem;
            color: #bbb;
        }

        .recent-achievements {
            margin-top: 1.5rem;
        }

        .recent-achievements h4 {
            margin: 0 0 1rem 0;
            font-size: 1rem;
            color: #ddd;
        }

        .recent-achievements-list {
            margin-bottom: 1rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .empty-achievements {
            text-align: center;
            color: #888;
            padding: 1rem;
            font-style: italic;
        }

        .profile-btn {
            background-color: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .profile-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .profile-btn-primary {
            background-color: var(--accent-color, #4682ff);
        }

        .profile-btn-primary:hover {
            background-color: #3569cc;
        }

        .block-distribution {
            display: flex;
            flex-direction: column;
            height: 200px;
        }

        .block-distribution-chart {
            flex: 1;
            display: flex;
            align-items: flex-end;
            gap: 10px;
            margin-bottom: 10px;
        }

        .distribution-bar {
            flex: 1;
            background-color: rgba(255, 255, 255, 0.1);
            position: relative;
            border-top-left-radius: 4px;
            border-top-right-radius: 4px;
            transition: height 0.5s ease;
        }

        .distribution-bar .bar-value {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.9rem;
            color: #ddd;
        }

        .block-distribution-labels {
            display: flex;
            justify-content: space-between;
        }

        .block-label {
            flex: 1;
            text-align: center;
            font-size: 0.85rem;
        }

        .customization-section {
            margin-bottom: 1.5rem;
        }

        .customization-section h4 {
            margin: 0 0 0.75rem 0;
            font-size: 1rem;
            color: #ddd;
        }

        .avatar-options, .color-options {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .avatar-option {
            width: 50px;
            height: 50px;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .avatar-option i {
            font-size: 30px;
            color: #ddd;
        }

        .avatar-option:hover {
            background-color: rgba(70, 130, 255, 0.2);
        }

        .avatar-option.selected {
            border-color: var(--accent-color, #4682ff);
        }

        .avatar-option.selected i {
            color: var(--accent-color, #4682ff);
        }

        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s ease;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.selected {
            border-color: white;
            transform: scale(1.15);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .profile-select {
            width: 100%;
            padding: 0.5rem;
            background-color: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            color: white;
            margin-bottom: 0.5rem;
        }

        .unlock-info {
            font-size: 0.8rem;
            color: #888;
            font-style: italic;
            margin: 0.5rem 0 0 0;
        }

        .profile-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        /* Profile modal styles */
        .profile-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .profile-modal-content {
            background-color: #222;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.7);
        }

        .profile-modal-header {
            background-color: rgba(0, 0, 0, 0.3);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .profile-modal-header h3 {
            margin: 0;
            color: white;
        }

        .profile-modal-close {
            background: none;
            border: none;
            color: #999;
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .profile-modal-close:hover {
            color: white;
        }

        .profile-modal-body {
            padding: 1.5rem;
        }

        .profile-input {
            width: 100%;
            padding: 0.75rem;
            background-color: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            color: white;
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .profile-input-hint {
            font-size: 0.85rem;
            color: #888;
            margin: 0;
        }

        .profile-modal-footer {
            padding: 1rem;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .profile-btn-cancel {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Responsive adaptations */
        @media (max-width: 768px) {
            .profile-header {
                flex-direction: column;
                text-align: center;
                padding: 1rem;
            }
            
            .profile-panels {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .profile-level {
                margin-top: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="particles" id="particles"></div>
    
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>Menu</h2>
        </div>
        <div class="sidebar-menu">
            <div class="menu-item" data-section="profile">
                <i class="fas fa-user"></i>
                <span>Profile</span>
            </div>
            <div class="menu-item coming-soon" data-section="clans">
                <i class="fas fa-users"></i>
                <span>Clans</span>
                <div class="coming-soon-badge">Coming Soon</div>
            </div>
            <div class="menu-item" data-section="shop">
                <i class="fas fa-shopping-cart"></i>
                <span>Shop</span>
            </div>
            <div class="menu-item active" data-section="build">
                <i class="fas fa-cubes"></i>
                <span>Build</span>
            </div>
            <div class="menu-item" data-section="settings">
                <i class="fas fa-cog"></i>
                <span>Settings</span>
            </div>
            <div class="menu-item" data-section="updates">
                <i class="fas fa-history"></i>
                <span>Updates</span>
            </div>
            <div class="menu-item" data-section="achievements">
                <i class="fas fa-trophy"></i>
                <span>Achievements</span>
            </div>
        </div>
    </div>
    
    <div class="main-content">
        <div id="game-container">
            <h1 class="game-title"><span data-text="Block Clicker">Block Clicker</span></h1>
            
            <div id="score-display">Score: <span id="score">0</span></div>
            
            <div class="stats-container">
                <div class="stat">CPS: <span class="stat-value" id="clicks-per-second">0.0</span></div>
                <div class="stat">Best CPS: <span class="stat-value" id="best-cps">0.0</span></div>
            </div>
            
            <div id="clicker"></div>
        </div>

        <!-- Shop Section -->
        <div id="shop-section" class="game-section hidden">
            <h2 class="section-title">Block Shop</h2>
            <div class="shop-items">
                <div class="shop-item" data-id="red-block" data-price="50" data-level="0" data-increment="1" data-color="#ff3e3e">
                    <div class="shop-item-icon block-preview" style="background-color: #ff3e3e;"></div>
                    <div class="shop-item-info">
                        <h3>Red Block</h3>
                        <p>+1 Click Value & Energy Boost</p>
                        <div class="shop-item-stats">
                            <span class="level">Owned: <span class="level-value">0</span></span>
                            <span class="multiplier">×<span class="multiplier-value">1</span></span>
                        </div>
                    </div>
                    <div class="shop-item-price">
                        <i class="fas fa-coins"></i> <span class="price-value">50</span>
                    </div>
                </div>
                
                <div class="shop-item" data-id="blue-block" data-price="100" data-level="0" data-increment="0.5" data-color="#00eeff">
                    <div class="shop-item-icon block-preview" style="background-color: #00eeff;"></div>
                    <div class="shop-item-info">
                        <h3>Blue Block</h3>
                        <p>Auto-clicks (+0.5 CPS) & Generates Score</p>
                        <div class="shop-item-stats">
                            <span class="level">Owned: <span class="level-value">0</span></span>
                            <span class="multiplier"><span class="multiplier-value">0</span> CPS</span>
                        </div>
                    </div>
                    <div class="shop-item-price">
                        <i class="fas fa-coins"></i> <span class="price-value">100</span>
                    </div>
                </div>
                
                <div class="shop-item" data-id="gold-block" data-price="200" data-level="0" data-increment="5" data-color="#ffd700">
                    <div class="shop-item-icon block-preview" style="background-color: #ffd700;"></div>
                    <div class="shop-item-info">
                        <h3>Gold Block</h3>
                        <p>+5% Random Bonus & Spawns Coins</p>
                        <div class="shop-item-stats">
                            <span class="level">Owned: <span class="level-value">0</span></span>
                            <span class="multiplier">+<span class="multiplier-value">0</span>%</span>
                        </div>
                    </div>
                    <div class="shop-item-price">
                        <i class="fas fa-coins"></i> <span class="price-value">200</span>
                    </div>
                </div>
                
                <div class="shop-item" data-id="purple-block" data-price="300" data-level="0" data-increment="2" data-color="#8a2be2">
                    <div class="shop-item-icon block-preview" style="background-color: #8a2be2;"></div>
                    <div class="shop-item-info">
                        <h3>Purple Block</h3>
                        <p>Multiplies adjacent blocks' power</p>
                        <div class="shop-item-stats">
                            <span class="level">Owned: <span class="level-value">0</span></span>
                        </div>
                    </div>
                    <div class="shop-item-price">
                        <i class="fas fa-coins"></i> <span class="price-value">300</span>
                    </div>
                </div>
                
                <div class="shop-item" data-id="green-block" data-price="150" data-level="0" data-increment="1.5" data-color="#32cd32">
                    <div class="shop-item-icon block-preview" style="background-color: #32cd32;"></div>
                    <div class="shop-item-info">
                        <h3>Green Block</h3>
                        <p>Self-regenerates when broken</p>
                        <div class="shop-item-stats">
                            <span class="level">Owned: <span class="level-value">0</span></span>
                        </div>
                    </div>
                    <div class="shop-item-price">
                        <i class="fas fa-coins"></i> <span class="price-value">150</span>
                    </div>
                </div>
                
                <div class="shop-item" data-id="black-block" data-price="250" data-level="0" data-increment="3" data-color="#333333">
                    <div class="shop-item-icon block-preview" style="background-color: #333333;"></div>
                    <div class="shop-item-info">
                        <h3>Black Block</h3>
                        <p>Super strong, supports 2x blocks</p>
                        <div class="shop-item-stats">
                            <span class="level">Owned: <span class="level-value">0</span></span>
                        </div>
                    </div>
                    <div class="shop-item-price">
                        <i class="fas fa-coins"></i> <span class="price-value">250</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Build Section -->
        <div id="build-section" class="game-section">
            <h2 class="section-title">Block Builder</h2>
            
            <div class="build-instructions">
                <p><i class="fas fa-info-circle"></i> Build from the ground up! Blocks must be placed on the ground or on top of other blocks.</p>
                <p><i class="fas fa-mouse-pointer"></i> Left-click to place a block. <i class="fas fa-hand-point-up"></i> Right-click to remove a block (only if no blocks are on top of it).</p>
                <p><i class="fas fa-coins"></i> Earn score rewards when you place blocks! More expensive blocks give higher rewards.</p>
                <p><i class="fas fa-magic"></i> Each block type has special properties! Hover over blocks to see what they do.</p>
            </div>
            
            <div class="build-interface">
                <div class="inventory">
                    <h3>Your Blocks</h3>
                    <div class="inventory-blocks" id="inventory-blocks">
                        <!-- Inventory blocks will be added here dynamically -->
                    </div>
                </div>
                
                <div class="builder-container">
                    <div class="builder-controls">
                        <button id="clear-build" class="builder-control-btn">
                            <i class="fas fa-trash"></i> Clear
                        </button>
                        <button id="save-build" class="builder-control-btn">
                            <i class="fas fa-save"></i> Save
                        </button>
                        <button id="load-build" class="builder-control-btn">
                            <i class="fas fa-folder-open"></i> Load
                        </button>
                    </div>
                    
                    <!-- Build slots selection -->
                    <div class="build-slots">
                        <div class="build-slots-header">
                            <h3>Build Slots</h3>
                            <div class="slot-actions">
                                <button id="rename-slot" class="builder-control-btn">
                                    <i class="fas fa-pencil-alt"></i> Rename
                                </button>
                                <button id="add-slot" class="builder-control-btn">
                                    <i class="fas fa-plus"></i> Add Slot
                                </button>
                            </div>
                        </div>
                        <div class="build-slots-container" id="build-slots-container">
                            <!-- Build slots will be added here dynamically -->
                        </div>
                    </div>
                    
                    <div class="build-area" id="build-area">
                        <!-- Grid for placing blocks -->
                        <div class="grid-container" id="grid-container">
                            <!-- Grid cells will be generated dynamically -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Section -->
        <div id="profile-section" class="game-section hidden">
            <h2 class="section-title">Player Profile</h2>
            
            <div class="profile-container">
                <!-- Profile Header -->
                <div class="profile-header">
                    <div class="profile-avatar">
                        <div class="avatar-image">
                            <i class="fas fa-user-circle"></i>
                        </div>
                        <button class="change-avatar-btn">
                            <i class="fas fa-camera"></i>
                        </button>
                    </div>
                    <div class="profile-info">
                        <h3 class="profile-name">Player <i class="fas fa-pencil-alt edit-name-btn"></i></h3>
                        <div class="profile-title">Beginner</div>
                    </div>
                    <div class="profile-level">
                        <div class="level-badge">
                            <span class="level-number">1</span>
                        </div>
                        <div class="level-progress-container">
                            <div class="level-progress"></div>
                        </div>
                        <div class="level-text">
                            <span class="current-xp">0</span>/<span class="next-level-xp">1000</span> XP
                        </div>
                    </div>
                </div>
                
                <!-- Profile Content -->
                <div class="profile-panels">
                    <!-- Game Stats Panel -->
                    <div class="profile-panel">
                        <div class="panel-header">
                            <i class="fas fa-chart-bar"></i>
                            <h3>Game Statistics</h3>
                        </div>
                        <div class="panel-content stats-grid">
                            <div class="stat-item">
                                <div class="stat-label">Total Score</div>
                                <div class="stat-value" id="profile-total-score">0</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Total Clicks</div>
                                <div class="stat-value" id="profile-total-clicks">0</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Best CPS</div>
                                <div class="stat-value" id="profile-best-cps">0.0</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Blocks Placed</div>
                                <div class="stat-value" id="profile-blocks-placed">0</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Blocks Removed</div>
                                <div class="stat-value" id="profile-blocks-removed">0</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Play Time</div>
                                <div class="stat-value" id="profile-play-time">0h 0m</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Achievements Panel -->
                    <div class="profile-panel">
                        <div class="panel-header">
                            <i class="fas fa-trophy"></i>
                            <h3>Achievements</h3>
                        </div>
                        <div class="panel-content">
                            <div class="achievement-progress-bar">
                                <div class="achievement-progress"></div>
                                <div class="achievement-progress-text">
                                    <span id="profile-achievements-count">0</span>/<span id="profile-achievements-total">0</span> Achievements
                                </div>
                            </div>
                            <div class="recent-achievements">
                                <h4>Recent Achievements</h4>
                                <div class="recent-achievements-list" id="recent-achievements-list">
                                    <div class="empty-achievements">No achievements yet. Keep playing!</div>
                                </div>
                                <button class="profile-btn" id="view-all-achievements">View All Achievements</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Building Stats Panel -->
                    <div class="profile-panel">
                        <div class="panel-header">
                            <i class="fas fa-cubes"></i>
                            <h3>Building History</h3>
                        </div>
                        <div class="panel-content">
                            <div class="block-distribution">
                                <div class="block-distribution-chart" id="block-distribution-chart">
                                    <!-- Block distribution bars will be generated here -->
                                </div>
                                <div class="block-distribution-labels">
                                    <div class="block-label" style="color: #ff3e3e;">Red</div>
                                    <div class="block-label" style="color: #00eeff;">Blue</div>
                                    <div class="block-label" style="color: #ffd700;">Gold</div>
                                    <div class="block-label" style="color: #8a2be2;">Purple</div>
                                    <div class="block-label" style="color: #32cd32;">Green</div>
                                    <div class="block-label" style="color: #333333;">Black</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Customization Panel -->
                    <div class="profile-panel">
                        <div class="panel-header">
                            <i class="fas fa-paint-brush"></i>
                            <h3>Customization</h3>
                        </div>
                        <div class="panel-content">
                            <!-- Avatar Selection -->
                            <div class="customization-section">
                                <h4>Choose Avatar</h4>
                                <div class="avatar-options">
                                    <div class="avatar-option selected" data-avatar="user-circle">
                                        <i class="fas fa-user-circle"></i>
                                    </div>
                                    <div class="avatar-option" data-avatar="user-astronaut">
                                        <i class="fas fa-user-astronaut"></i>
                                    </div>
                                    <div class="avatar-option" data-avatar="user-ninja">
                                        <i class="fas fa-user-ninja"></i>
                                    </div>
                                    <div class="avatar-option" data-avatar="user-tie">
                                        <i class="fas fa-user-tie"></i>
                                    </div>
                                    <div class="avatar-option" data-avatar="user-secret">
                                        <i class="fas fa-user-secret"></i>
                                    </div>
                                    <div class="avatar-option" data-avatar="user-graduate">
                                        <i class="fas fa-user-graduate"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Color Selection -->
                            <div class="customization-section">
                                <h4>Theme Color</h4>
                                <div class="color-options">
                                    <div class="color-option selected" data-color="#4682ff" style="background-color: #4682ff;"></div>
                                    <div class="color-option" data-color="#ff3e3e" style="background-color: #ff3e3e;"></div>
                                    <div class="color-option" data-color="#32cd32" style="background-color: #32cd32;"></div>
                                    <div class="color-option" data-color="#8a2be2" style="background-color: #8a2be2;"></div>
                                    <div class="color-option" data-color="#ffd700" style="background-color: #ffd700;"></div>
                                    <div class="color-option" data-color="#ff69b4" style="background-color: #ff69b4;"></div>
                                </div>
                            </div>
                            
                            <!-- Title Selection -->
                            <div class="customization-section">
                                <h4>Player Title</h4>
                                <select id="player-title" class="profile-select">
                                    <option value="Beginner">Beginner</option>
                                    <option value="Block Builder">Block Builder</option>
                                    <option value="Click Master">Click Master</option>
                                    <option value="Architect">Architect</option>
                                    <option value="Block Mogul">Block Mogul</option>
                                </select>
                                <p class="unlock-info">More titles will unlock as you level up and complete achievements!</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Profile Actions -->
                <div class="profile-actions">
                    <button class="profile-btn" id="reset-profile">Reset Profile</button>
                    <button class="profile-btn profile-btn-primary" id="save-profile">Save Changes</button>
                </div>
            </div>
            
            <!-- Change Name Modal -->
            <div class="profile-modal" id="change-name-modal" style="display: none;">
                <div class="profile-modal-content">
                    <div class="profile-modal-header">
                        <h3>Change Player Name</h3>
                        <button class="profile-modal-close">&times;</button>
                    </div>
                    <div class="profile-modal-body">
                        <input type="text" id="new-player-name" class="profile-input" placeholder="Enter a new name">
                        <p class="profile-input-hint">Choose a name between 3-20 characters</p>
                    </div>
                    <div class="profile-modal-footer">
                        <button class="profile-btn profile-btn-cancel">Cancel</button>
                        <button class="profile-btn profile-btn-primary" id="save-player-name">Save</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Clans Section (Coming Soon) -->
        <div id="clans-section" class="game-section hidden">
            <div class="coming-soon-container">
                <i class="fas fa-users-crown"></i>
                <h2>Clans Coming Soon</h2>
                <p>Team up with friends and compete for the top spot!</p>
            </div>
        </div>

        <!-- Settings Section -->
        <div id="settings-section" class="game-section hidden">
            <h2 class="section-title">Game Settings</h2>
            
            <div class="settings-container">
                <div class="settings-group">
                    <h3><i class="fas fa-palette"></i> Visual Settings</h3>
                    <div class="setting-item">
                        <label for="toggle-particles">Background Particles</label>
                        <div class="toggle-switch">
                            <input type="checkbox" id="toggle-particles" checked>
                            <span class="toggle-slider"></span>
                        </div>
                    </div>
                    <div class="setting-item">
                        <label for="theme-selector">Game Theme</label>
                        <select id="theme-selector" class="settings-select">
                            <option value="default">Default</option>
                            <option value="dark">Dark Mode</option>
                            <option value="neon">Neon</option>
                            <option value="retro">Retro</option>
                        </select>
                    </div>
                </div>
                
                <div class="settings-group">
                    <h3><i class="fas fa-volume-up"></i> Sound Settings</h3>
                    <div class="setting-item">
                        <label for="toggle-sound">Sound Effects</label>
                        <div class="toggle-switch">
                            <input type="checkbox" id="toggle-sound" checked>
                            <span class="toggle-slider"></span>
                        </div>
                    </div>
                    <div class="setting-item">
                        <label for="sound-volume">Sound Volume</label>
                        <div class="slider-container">
                            <input type="range" id="sound-volume" min="0" max="100" value="80" class="settings-slider">
                            <span class="volume-value">80%</span>
                        </div>
                    </div>
                </div>
                
                <div class="settings-group">
                    <h3><i class="fas fa-gamepad"></i> Gameplay Settings</h3>
                    <div class="setting-item">
                        <label for="difficulty-selector">Block Physics</label>
                        <select id="difficulty-selector" class="settings-select">
                            <option value="normal">Normal</option>
                            <option value="relaxed">Relaxed</option>
                            <option value="strict">Strict</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label for="auto-save">Auto-Save Builds</label>
                        <div class="toggle-switch">
                            <input type="checkbox" id="auto-save" checked>
                            <span class="toggle-slider"></span>
                        </div>
                    </div>
                    <div class="setting-item">
                        <label for="auto-save-interval">Auto-Save Interval</label>
                        <select id="auto-save-interval" class="settings-select">
                            <option value="30000">30 Seconds</option>
                            <option value="60000">1 Minute</option>
                            <option value="300000">5 Minutes</option>
                        </select>
                    </div>
                </div>
                
                <div class="settings-group">
                    <h3><i class="fas fa-universal-access"></i> Accessibility</h3>
                    <div class="setting-item">
                        <label for="text-size">Text Size</label>
                        <select id="text-size" class="settings-select">
                            <option value="normal">Normal</option>
                            <option value="large">Large</option>
                            <option value="extra-large">Extra Large</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label for="high-contrast">High Contrast Mode</label>
                        <div class="toggle-switch">
                            <input type="checkbox" id="high-contrast">
                            <span class="toggle-slider"></span>
                        </div>
                    </div>
                    <div class="setting-item">
                        <label for="reduce-motion">Reduce Animations</label>
                        <div class="toggle-switch">
                            <input type="checkbox" id="reduce-motion">
                            <span class="toggle-slider"></span>
                        </div>
                    </div>
                </div>
                
                <div class="settings-group">
                    <h3><i class="fas fa-database"></i> Data Management</h3>
                    <div class="setting-item">
                        <label>Export Game Data</label>
                        <button id="export-game" class="settings-btn">
                            <i class="fas fa-file-export"></i> Export
                        </button>
                    </div>
                    <div class="setting-item">
                        <label>Import Game Data</label>
                        <button id="import-game" class="settings-btn">
                            <i class="fas fa-file-import"></i> Import
                        </button>
                    </div>
                    <div class="setting-item data-management-info">
                        <p>Export your game progress to transfer to another device or to keep as a backup.</p>
                    </div>
                </div>
            </div>
            
            <div class="settings-actions">
                <button id="reset-settings" class="settings-btn">Reset to Default</button>
                <button id="save-settings" class="settings-btn settings-btn-primary">Save Settings</button>
            </div>
        </div>

        <!-- Updates Section -->
        <div id="updates-section" class="game-section hidden">
            <h2 class="section-title">Update Log</h2>
            
            <div class="update-log-container">
                <div class="update-version">
                    <div class="version-header">
                        <span class="version-number">v1.3.2</span>
                        <span class="version-date">5/12/25 (Today)</span>
                    </div>
                    <div class="version-changes">
                        <ul>
                            <li>Added new building reward system - earn score when placing blocks!</li>
                            <li>Added import/export system for game data</li>
                            <li>New update log system to track game changes</li>
                            <li>Fixed bug where auto-clickers would stop working after device sleep</li>
                            <li>Updated UI theme system with better contrast options</li>
                            <li>Performance improvements for large block structures</li>
                        </ul>
                    </div>
                </div>
                
                <div class="update-version">
                    <div class="version-header">
                        <span class="version-number">v1.2.0</span>
                        <span class="version-date">5/11/25 (Yesterday)</span>
                    </div>
                    <div class="version-changes">
                        <ul>
                            <li>Added high contrast mode and text size options</li>
                            <li>New "Reduce Animations" accessibility setting</li>
                            <li>Added the black reinforced block type</li>
                            <li>Optimized particle system for better performance</li>
                            <li>Fixed collision issues in strict physics mode</li>
                        </ul>
                    </div>
                </div>
                
                <div class="update-version">
                    <div class="version-header">
                        <span class="version-number">v1.1.5</span>
                        <span class="version-date">5/5/25</span>
                    </div>
                    <div class="version-changes">
                        <ul>
                            <li>Added multiple build slot support (up to 5 slots)</li>
                            <li>Custom naming for saved builds</li>
                            <li>Auto-save functionality with configurable intervals</li>
                            <li>Fixed touch controls on mobile devices</li>
                            <li>Improved block placement mechanics</li>
                        </ul>
                    </div>
                </div>
                
                <div class="update-version">
                    <div class="version-header">
                        <span class="version-number">v1.0.4</span>
                        <span class="version-date">4/17/25</span>
                    </div>
                    <div class="version-changes">
                        <ul>
                            <li>Added green regenerative blocks</li>
                            <li>Added three physics difficulty levels: Normal, Relaxed, and Strict</li>
                            <li>Fixed audio playback issues on Safari browsers</li>
                            <li>Added bonus chance mechanic for gold blocks</li>
                            <li>Improved build grid with better visual feedback</li>
                        </ul>
                    </div>
                </div>
                
                <div class="update-version">
                    <div class="version-header">
                        <span class="version-number">v1.0.2</span>
                        <span class="version-date">3/28/25</span>
                    </div>
                    <div class="version-changes">
                        <ul>
                            <li>Added block tooltips with detailed information</li>
                            <li>Implemented CPS (Clicks Per Second) tracking</li>
                            <li>Added sound effects for gameplay actions</li>
                            <li>New gold block with coin spawn ability</li>
                            <li>Fixed inventory display issues</li>
                        </ul>
                    </div>
                </div>
                
                <div class="update-version">
                    <div class="version-header">
                        <span class="version-number">v1.0.0</span>
                        <span class="version-date">3/1/25</span>
                    </div>
                    <div class="version-changes">
                        <ul>
                            <li>Initial release of Block Clicker</li>
                            <li>Basic clicking mechanics with multipliers</li>
                            <li>Added red and blue block types</li>
                            <li>Simple building interface with grid system</li>
                            <li>Basic score tracking and auto-clicker system</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Achievements Section -->
        <div id="achievements-section" class="game-section hidden">
            <h2 class="section-title">Achievements</h2>
            
            <div class="achievements-container">
                <div class="achievements-summary">
                    <div class="achievement-stats">
                        <div class="achievement-stat">
                            <span class="stat-label">Unlocked:</span>
                            <span class="stat-value" id="achievements-unlocked">0</span>/<span id="achievements-total">0</span>
                        </div>
                        <div class="achievement-stat">
                            <span class="stat-label">Completion:</span>
                            <span class="stat-value" id="achievements-percentage">0%</span>
                        </div>
                    </div>
                </div>
                
                <div class="achievements-grid" id="achievements-grid">
                    <!-- Achievements will be added here dynamically -->
                </div>
            </div>
        </div>

        <!-- Ad container -->
        <div class="ad-container">
            <!-- Google AdSense Ad Unit -->
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-3727712535529004"
                 data-ad-slot="XXXXXXXXXX"
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>
            <script>
                 (adsbygoogle = window.adsbygoogle || []).push({});
            </script>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const clicker = document.getElementById('clicker');
            const scoreElement = document.getElementById('score');
            const cpsElement = document.getElementById('clicks-per-second');
            const bestCpsElement = document.getElementById('best-cps');
            const particles = document.getElementById('particles');
            const menuItems = document.querySelectorAll('.menu-item');
            const gameSections = document.querySelectorAll('.game-section');
            const shopItems = document.querySelectorAll('.shop-item');
            const inventoryBlocksContainer = document.getElementById('inventory-blocks');
            const buildArea = document.getElementById('build-area');
            const gridContainer = document.getElementById('grid-container');
            const clearBuildBtn = document.getElementById('clear-build');
            const saveBuildBtn = document.getElementById('save-build');
            const loadBuildBtn = document.getElementById('load-build');
            const buildSlotsContainer = document.getElementById('build-slots-container');
            const renameSlotBtn = document.getElementById('rename-slot');
            const addSlotBtn = document.getElementById('add-slot');
            
            // Game state variables
            let score = 0;
            let clicks = 0;
            let lastClick = Date.now();
            let clickTimes = [];
            let bestCps = 0;
            let clickMultiplier = 1;
            let autoClickValue = 0;
            let bonusClickChance = 0;
            let autoClickerInterval;
            let selectedBlockType = null;
            let hasShownBuildingTip = false;
            
            // Game version information
            const gameVersion = {
                current: "1.3.2",
                releaseDate: "5/12/25",
                isNew: function(days = 30) {
                    // Check if this version is less than 'days' old based on releaseDate
                    const releaseTime = new Date(this.releaseDate).getTime();
                    const now = Date.now();
                    const daysDiff = Math.floor((now - releaseTime) / (1000 * 60 * 60 * 24));
                    return daysDiff < days;
                }
            };
            
            // Achievements system
            let achievements = {
                clickCount: 0,      // Total clicks
                buildCount: 0,      // Total blocks placed
                buyCount: 0,        // Total shop purchases
                highestScore: 0,    // Highest score
                totalScore: 0,      // Total score earned (cumulative)
                redBlocks: 0,       // Blocks by type
                blueBlocks: 0,
                goldBlocks: 0,
                purpleBlocks: 0,
                greenBlocks: 0,
                blackBlocks: 0,
                blocksPlaced: 0,    // Total blocks placed
                blocksRemoved: 0,   // Total blocks removed
                unlockedAchievements: [],  // IDs of unlocked achievements
            };
            
            // Achievement definitions
            const achievementsList = [
                // Clicking achievements
                {
                    id: "click_10",
                    name: "Click Beginner",
                    description: "Click the clicker 10 times",
                    icon: "fa-mouse-pointer",
                    type: "clicks",
                    requirement: 10,
                    progressFn: () => achievements.clickCount,
                    unlocked: false
                },
                {
                    id: "click_100",
                    name: "Click Enthusiast",
                    description: "Click the clicker 100 times",
                    icon: "fa-mouse-pointer",
                    type: "clicks",
                    requirement: 100,
                    progressFn: () => achievements.clickCount,
                    unlocked: false
                },
                {
                    id: "click_1000",
                    name: "Click Maestro",
                    description: "Click the clicker 1,000 times",
                    icon: "fa-mouse-pointer",
                    type: "clicks",
                    requirement: 1000,
                    progressFn: () => achievements.clickCount,
                    unlocked: false
                },
                
                // Score achievements
                {
                    id: "score_100",
                    name: "First Fortune",
                    description: "Reach a score of 100",
                    icon: "fa-coins",
                    type: "score",
                    requirement: 100,
                    progressFn: () => score,
                    unlocked: false
                },
                {
                    id: "score_1000",
                    name: "Score Collector",
                    description: "Reach a score of 1,000",
                    icon: "fa-coins",
                    type: "score",
                    requirement: 1000,
                    progressFn: () => score,
                    unlocked: false
                },
                {
                    id: "score_10000",
                    name: "Score Hoarder",
                    description: "Reach a score of 10,000",
                    icon: "fa-coins",
                    type: "score",
                    requirement: 10000,
                    progressFn: () => score,
                    unlocked: false
                },
                
                // Building achievements
                {
                    id: "build_5",
                    name: "Block Builder",
                    description: "Place 5 blocks in your build",
                    icon: "fa-cubes",
                    type: "building",
                    requirement: 5,
                    progressFn: () => achievements.blocksPlaced,
                    unlocked: false
                },
                {
                    id: "build_25",
                    name: "Master Builder",
                    description: "Place 25 blocks in your build",
                    icon: "fa-cubes",
                    type: "building",
                    requirement: 25,
                    progressFn: () => achievements.blocksPlaced,
                    unlocked: false
                },
                {
                    id: "build_100",
                    name: "Architect",
                    description: "Place 100 blocks in your build",
                    icon: "fa-cubes",
                    type: "building",
                    requirement: 100,
                    progressFn: () => achievements.blocksPlaced,
                    unlocked: false
                },
                
                // Block type achievements
                {
                    id: "all_block_types",
                    name: "Collector",
                    description: "Place at least one of each block type",
                    icon: "fa-layer-group",
                    type: "special",
                    requirement: 6,
                    progressFn: () => {
                        let count = 0;
                        if (achievements.redBlocks > 0) count++;
                        if (achievements.blueBlocks > 0) count++;
                        if (achievements.goldBlocks > 0) count++;
                        if (achievements.purpleBlocks > 0) count++;
                        if (achievements.greenBlocks > 0) count++;
                        if (achievements.blackBlocks > 0) count++;
                        return count;
                    },
                    unlocked: false
                },
                
                // Special achievements
                {
                    id: "first_bonus",
                    name: "Lucky Strike",
                    description: "Get your first bonus click",
                    icon: "fa-star",
                    type: "special",
                    special: true,
                    unlocked: false
                },
                {
                    id: "cps_10",
                    name: "Speed Clicker",
                    description: "Reach 10 clicks per second",
                    icon: "fa-tachometer-alt",
                    type: "special",
                    requirement: 10,
                    progressFn: () => bestCps,
                    unlocked: false
                }
            ];
            
            // Sound system
            const sounds = {
                click: new Audio('data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU'), // Empty placeholder
                place: new Audio('data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU'),
                remove: new Audio('data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU'),
                bonus: new Audio('data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU'),
                achievement: new Audio('data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU')
            };
            
            // Function to play sounds
            function playSound(soundName) {
                if (gameSettings.sound.enabled) {
                    // If there's a real sound, we would set the volume
                    const sound = sounds[soundName];
                    if (sound) {
                        sound.volume = gameSettings.sound.volume / 100;
                        
                        // Reset and play
                        sound.currentTime = 0;
                        sound.play().catch(e => {
                            // Ignore autoplay errors - browsers require user interaction
                        });
                    }
                }
            }
            
            // Build slots variables
            let currentBuildSlot = 1;
            let maxBuildSlots = 5;
            let buildSlots = {};
            
            // Game settings
            let gameSettings = {
                visual: {
                    particles: true,
                    theme: 'default'
                },
                sound: {
                    enabled: true,
                    volume: 80
                },
                gameplay: {
                    physics: 'normal',
                    autoSave: true,
                    autoSaveInterval: 60000 // 1 minute
                },
                accessibility: {
                    textSize: 'normal',
                    highContrast: false,
                    reduceMotion: false
                }
            };
            
            // Auto-save timer
            let autoSaveTimer;
            
            // Block effects timers and state
            let blockEffectsInterval;
            let coinSpawnInterval;
            let lastBlockEffectTime = Date.now();
            let activeEffects = [];
            
            // Block properties and their effects
            const blockProperties = {
                "red-block": { 
                    name: "Red Block", 
                    color: "#ff3e3e", 
                    description: "Emits energy that boosts nearby blocks by 10%",
                    effect: "energy-boost",
                    radius: 2
                },
                "blue-block": { 
                    name: "Blue Block", 
                    color: "#00eeff", 
                    description: "Generates 1 score every 5 seconds",
                    effect: "score-generator",
                    interval: 5000,
                    value: 1
                },
                "gold-block": { 
                    name: "Gold Block", 
                    color: "#ffd700", 
                    description: "Has 10% chance to spawn bonus coins every 10 seconds",
                    effect: "coin-spawner",
                    chance: 0.1,
                    interval: 10000,
                    value: 5
                },
                "purple-block": { 
                    name: "Purple Block", 
                    color: "#8a2be2", 
                    description: "Multiplies the effect of adjacent blocks by 1.5x",
                    effect: "multiplier",
                    factor: 1.5,
                    radius: 1
                },
                "green-block": { 
                    name: "Green Block", 
                    color: "#32cd32", 
                    description: "If removed, has 50% chance to regenerate after 8 seconds",
                    effect: "regenerative",
                    chance: 0.5,
                    regrowTime: 8000
                },
                "black-block": { 
                    name: "Black Block", 
                    color: "#333333", 
                    description: "Super strong - can support twice as many blocks on top",
                    effect: "reinforced",
                    factor: 2
                }
            };
            
            // Inventory of blocks
            let blockInventory = {
                "red-block": { count: 0, color: "#ff3e3e", name: "Red Block" },
                "blue-block": { count: 0, color: "#00eeff", name: "Blue Block" },
                "gold-block": { count: 0, color: "#ffd700", name: "Gold Block" },
                "purple-block": { count: 0, color: "#8a2be2", name: "Purple Block" },
                "green-block": { count: 0, color: "#32cd32", name: "Green Block" },
                "black-block": { count: 0, color: "#333333", name: "Black Block" }
            };
            
            // Structure for saving/loading builds
            let buildStructure = [];
            
            // Create background particles
            for (let i = 0; i < 50; i++) {
                createParticle();
            }

            // Initialize grid
            createGrid();
            refreshInventory();
            
            // Initialize build slots
            initializeBuildSlots();
            
            // Load and apply saved settings
            loadSettings();
            
            // Start auto-save if enabled
            startAutoSave();
            
            // Start block effects timer
            startBlockEffects();

            function createGrid() {
                gridContainer.innerHTML = '';
                for (let row = 0; row < 20; row++) {
                    for (let col = 0; col < 20; col++) {
                        const cell = document.createElement('div');
                        cell.classList.add('grid-cell');
                        cell.setAttribute('data-row', row);
                        cell.setAttribute('data-col', col);
                        
                        // Set ground level (last row)
                        if (row === 19) {
                            cell.classList.add('ground');
                        }
                        
                        // Hover effect to check if placement is valid
                        cell.addEventListener('mouseover', function() {
                            if (selectedBlockType && blockInventory[selectedBlockType].count > 0) {
                                const canPlace = canPlaceBlockAt(row, col);
                                if (canPlace) {
                                    this.classList.add('valid-placement');
                                    this.classList.remove('invalid-placement');
                                    
                                    // Show block description tooltip
                                    showBlockTooltip(this, selectedBlockType);
                                } else {
                                    this.classList.add('invalid-placement');
                                    this.classList.remove('valid-placement');
                                    hideBlockTooltip();
                                }
                            } else if (this.classList.contains('has-block')) {
                                // Show tooltip for placed blocks
                                const blockType = this.getAttribute('data-block-type');
                                showBlockTooltip(this, blockType);
                            }
                        });
                        
                        cell.addEventListener('mouseout', function() {
                            this.classList.remove('valid-placement', 'invalid-placement');
                            hideBlockTooltip();
                        });
                        
                        // Add click handler for placing blocks
                        cell.addEventListener('click', function(e) {
                            // Right click to remove
                            if (e.button === 2) {
                                return;
                            }
                            
                            if (selectedBlockType && blockInventory[selectedBlockType].count > 0) {
                                const row = parseInt(this.getAttribute('data-row'));
                                const col = parseInt(this.getAttribute('data-col'));
                                
                                if (canPlaceBlockAt(row, col)) {
                                    placeBlock(this, selectedBlockType);
                                } else {
                                    // Visual feedback that block can't be placed here
                                    cell.classList.add('invalid-placement');
                                    setTimeout(() => {
                                        cell.classList.remove('invalid-placement');
                                    }, 300);
                                }
                            }
                        });
                        
                        // Right-click to remove blocks
                        cell.addEventListener('contextmenu', function(e) {
                            e.preventDefault();
                            if (cell.classList.contains('has-block') && canRemoveBlock(cell)) {
                                const blockType = cell.getAttribute('data-block-type');
                                
                                // Check for green block regeneration
                                if (blockType === 'green-block' && Math.random() < blockProperties[blockType].chance) {
                                    // Create visual indicator for regeneration
                                    const indicator = document.createElement('div');
                                    indicator.className = 'regeneration-indicator';
                                    indicator.innerHTML = '<i class="fas fa-recycle"></i>';
                                    
                                    // Position it over the cell
                                    const rect = cell.getBoundingClientRect();
                                    indicator.style.left = rect.left + rect.width/2 + 'px';
                                    indicator.style.top = rect.top + rect.height/2 + 'px';
                                    
                                    document.body.appendChild(indicator);
                                    
                                    setTimeout(() => {
                                        indicator.remove();
                                        // Restore the green block if the cell is still empty
                                        if (!cell.classList.contains('has-block')) {
                                            placeBlock(cell, 'green-block', true); // true = is regenerating
                                        }
                                    }, blockProperties[blockType].regrowTime);
                                }
                                
                                removeBlock(cell);
                            }
                            return false;
                        });
                        
                        gridContainer.appendChild(cell);
                    }
                }
                
                // Prevent context menu on right-click within the grid
                gridContainer.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    return false;
                });
            }
            
            // Show tooltip with block description
            function showBlockTooltip(cell, blockType) {
                // Remove any existing tooltips
                hideBlockTooltip();
                
                const tooltip = document.createElement('div');
                tooltip.className = 'block-tooltip';
                tooltip.textContent = blockProperties[blockType].description;
                
                // Position the tooltip above the cell
                const rect = cell.getBoundingClientRect();
                tooltip.style.left = rect.left + 'px';
                tooltip.style.top = (rect.top - 40) + 'px';
                
                document.body.appendChild(tooltip);
            }
            
            function hideBlockTooltip() {
                const tooltip = document.querySelector('.block-tooltip');
                if (tooltip) {
                    tooltip.remove();
                }
            }

            // Check if a block can be placed at a specific location
            function canPlaceBlockAt(row, col) {
                // Get current physics setting
                const physics = gameSettings.gameplay.physics;
                
                // Already has a block
                const cell = document.querySelector(`.grid-cell[data-row="${row}"][data-col="${col}"]`);
                if (cell.classList.contains('has-block')) {
                    return false;
                }
                
                // Is ground level
                if (row === 19) {
                    return true;
                }
                
                // Check if there's a block below
                const cellBelow = document.querySelector(`.grid-cell[data-row="${row + 1}"][data-col="${col}"]`);
                if (cellBelow && cellBelow.classList.contains('has-block')) {
                    // If it's a black block (reinforced), it can support more blocks
                    if (cellBelow.getAttribute('data-block-type') === 'black-block') {
                        return true; // Black blocks always support blocks above
                    }
                    
                    return true; // Regular blocks support one block above
                }
                
                // If physics is relaxed, also allow placing if there are blocks to the left or right
                if (physics === 'relaxed') {
                    // Check left
                    const cellLeft = document.querySelector(`.grid-cell[data-row="${row}"][data-col="${col - 1}"]`);
                    if (cellLeft && cellLeft.classList.contains('has-block')) {
                        return true;
                    }
                    
                    // Check right
                    const cellRight = document.querySelector(`.grid-cell[data-row="${row}"][data-col="${col + 1}"]`);
                    if (cellRight && cellRight.classList.contains('has-block')) {
                        return true;
                    }
                }
                
                // If physics is strict, require 2 blocks below for support (except for black blocks)
                if (physics === 'strict') {
                    // If the cell below doesn't have a block or is a black block, standard rules apply
                    if (!cellBelow || !cellBelow.classList.contains('has-block') || 
                        cellBelow.getAttribute('data-block-type') === 'black-block') {
                        return cellBelow && cellBelow.classList.contains('has-block');
                    }
                    
                    // For strict mode, also require at least one diagonal support
                    const cellBelowLeft = document.querySelector(`.grid-cell[data-row="${row + 1}"][data-col="${col - 1}"]`);
                    const hasBelowLeft = cellBelowLeft && cellBelowLeft.classList.contains('has-block');
                    
                    const cellBelowRight = document.querySelector(`.grid-cell[data-row="${row + 1}"][data-col="${col + 1}"]`);
                    const hasBelowRight = cellBelowRight && cellBelowRight.classList.contains('has-block');
                    
                    return hasBelowLeft || hasBelowRight;
                }
                
                return false;
            }

            function placeBlock(cell, blockType, isRegenerating = false) {
                // Don't place if there's already a block
                if (cell.classList.contains('has-block')) {
                    return;
                }
                
                const row = parseInt(cell.getAttribute('data-row'));
                const col = parseInt(cell.getAttribute('data-col'));
                
                // Check if we can place here (must be on ground or on another block)
                if (!canPlaceBlockAt(row, col)) {
                    return;
                }
                
                // Play place sound
                playSound('place');
                
                // Decrement block count in inventory (unless regenerating)
                if (!isRegenerating) {
                    blockInventory[blockType].count--;
                }
                
                // Track block placement for achievements
                if (!isRegenerating) {
                    // Increment total blocks placed
                    achievements.blocksPlaced++;
                    
                    // Increment the appropriate block type counter
                    if (blockType === 'red-block') achievements.redBlocks++;
                    else if (blockType === 'blue-block') achievements.blueBlocks++;
                    else if (blockType === 'gold-block') achievements.goldBlocks++;
                    else if (blockType === 'purple-block') achievements.purpleBlocks++;
                    else if (blockType === 'green-block') achievements.greenBlocks++;
                    else if (blockType === 'black-block') achievements.blackBlocks++;
                    
                    // Check achievements after placing a block
                    checkAchievements();
                    // Save achievement progress
                    saveAchievements();
                }
                
                // Find the original price of the block and reward the player with score based on building
                if (!isRegenerating) {
                    try {
                        // Get the shop item for this block type
                        const shopItem = document.querySelector(`.shop-item[data-id="${blockType}"]`);
                        if (shopItem) {
                            // Get the base price and calculate reward
                            const basePrice = parseInt(shopItem.getAttribute('data-price'));
                            const initialPrice = Math.floor(basePrice / 1.5); // Estimate original price before markup
                            const buildReward = Math.ceil(initialPrice * 0.3); // 30% of block's value
                            
                            // Add build reward to score - using the increment function ensures all UI is updated
                            incrementScore(buildReward);
                            
                            // Show building reward effect with hammer icon
                            const buildRewardEffect = document.createElement('div');
                            buildRewardEffect.className = 'score-effect build-reward';
                            buildRewardEffect.innerHTML = `<i class="fas fa-hammer"></i> +${buildReward}`;
                            
                            // Position the effect at the cell location
                            const rect = cell.getBoundingClientRect();
                            buildRewardEffect.style.left = (rect.left + rect.width/2) + 'px';
                            buildRewardEffect.style.top = (rect.top - 10) + 'px';
                            
                            // Add to document and remove after animation
                            document.body.appendChild(buildRewardEffect);
                            setTimeout(() => {
                                buildRewardEffect.remove();
                            }, 1500);
                            
                            // Show tutorial tip about building rewards if it's the first time
                            if (!hasShownBuildingTip) {
                                hasShownBuildingTip = true;
                                const tip = document.createElement('div');
                                tip.className = 'tutorial-tip';
                                tip.innerHTML = `
                                    <i class="fas fa-lightbulb"></i>
                                    <div class="tip-content">
                                        <h4>Building Rewards!</h4>
                                        <p>You now earn score for placing blocks! More expensive blocks give higher rewards.</p>
                                        <button class="close-tip">Got it!</button>
                                    </div>
                                `;
                                document.body.appendChild(tip);
                                
                                // Add event listener to close button
                                tip.querySelector('.close-tip').addEventListener('click', function() {
                                    tip.classList.add('tip-fadeout');
                                    setTimeout(() => {
                                        tip.remove();
                                    }, 500);
                                });
                                
                                // Auto close after 8 seconds
                                setTimeout(() => {
                                    if (document.body.contains(tip)) {
                                        tip.classList.add('tip-fadeout');
                                        setTimeout(() => {
                                            if (document.body.contains(tip)) {
                                                tip.remove();
                                            }
                                        }, 500);
                                    }
                                }, 8000);
                            }
                        }
                    } catch (error) {
                        console.error("Error applying building reward:", error);
                    }
                }
                
                // Update cell appearance
                cell.style.backgroundColor = blockInventory[blockType].color;
                cell.classList.add('has-block');
                cell.setAttribute('data-block-type', blockType);
                
                // Add special visual effects based on block type
                if (blockType === 'red-block') {
                    cell.classList.add('energy-emitter');
                } else if (blockType === 'blue-block') {
                    cell.classList.add('score-generator');
                } else if (blockType === 'gold-block') {
                    cell.classList.add('coin-spawner');
                } else if (blockType === 'purple-block') {
                    cell.classList.add('multiplier');
                    // Add glow to adjacent blocks
                    highlightAdjacentBlocks(row, col);
                } else if (blockType === 'green-block') {
                    cell.classList.add('regenerative');
                } else if (blockType === 'black-block') {
                    cell.classList.add('reinforced');
                }
                
                // If it's a block with an effect, add it to active effects
                if (blockProperties[blockType].effect) {
                    activeEffects.push({
                        type: blockType,
                        row: row,
                        col: col,
                        lastActivated: 0
                    });
                }
                
                // Update inventory display
                refreshInventory();
                
                // Save the current structure
                updateBuildStructure();
                
                // Show placement effect
                showPlacementEffect(cell, blockType);
            }
            
            // Highlight adjacent blocks for multiplier effect
            function highlightAdjacentBlocks(row, col) {
                const directions = [
                    {row: -1, col: 0}, // top
                    {row: 1, col: 0},  // bottom
                    {row: 0, col: -1}, // left
                    {row: 0, col: 1}   // right
                ];
                
                directions.forEach(dir => {
                    const adjacentCell = document.querySelector(
                        `.grid-cell[data-row="${row + dir.row}"][data-col="${col + dir.col}"]`
                    );
                    
                    if (adjacentCell && adjacentCell.classList.contains('has-block')) {
                        adjacentCell.classList.add('multiplier-boosted');
                    }
                });
            }
            
            // Show visual effect when placing a block
            function showPlacementEffect(cell, blockType) {
                // Create effect element
                const effect = document.createElement('div');
                effect.className = 'block-effect';
                
                // Customize based on block type
                if (blockType === 'red-block') {
                    effect.innerHTML = '<i class="fas fa-bolt"></i>';
                    effect.style.color = '#ff7b00';
                } else if (blockType === 'blue-block') {
                    effect.innerHTML = '<i class="fas fa-cog fa-spin"></i>';
                    effect.style.color = '#00eeff';
                } else if (blockType === 'gold-block') {
                    effect.innerHTML = '<i class="fas fa-coins"></i>';
                    effect.style.color = '#ffd700';
                } else if (blockType === 'purple-block') {
                    effect.innerHTML = '<i class="fas fa-star"></i>';
                    effect.style.color = '#e066ff';
                } else if (blockType === 'green-block') {
                    effect.innerHTML = '<i class="fas fa-seedling"></i>';
                    effect.style.color = '#32cd32';
                } else if (blockType === 'black-block') {
                    effect.innerHTML = '<i class="fas fa-shield-alt"></i>';
                    effect.style.color = '#aaaaaa';
                }
                
                // Position over the cell
                const rect = cell.getBoundingClientRect();
                effect.style.left = rect.left + rect.width/2 + 'px';
                effect.style.top = rect.top + rect.height/2 + 'px';
                
                document.body.appendChild(effect);
                
                // Remove after animation completes
                setTimeout(() => {
                    effect.remove();
                }, 1000);
            }
            
            // Start the block effects system
            function startBlockEffects() {
                // Clear any existing intervals
                if (blockEffectsInterval) {
                    clearInterval(blockEffectsInterval);
                }
                if (coinSpawnInterval) {
                    clearInterval(coinSpawnInterval);
                }
                
                // Handle regular block effects every second
                blockEffectsInterval = setInterval(() => {
                    processBlockEffects();
                }, 1000);
            }
            
            // Process all active block effects
            function processBlockEffects() {
                const now = Date.now();
                
                // Process each active effect
                activeEffects.forEach((effect, index) => {
                    const blockType = effect.type;
                    const props = blockProperties[blockType];
                    const cell = document.querySelector(`.grid-cell[data-row="${effect.row}"][data-col="${effect.col}"]`);
                    
                    // Skip if the block no longer exists
                    if (!cell || !cell.classList.contains('has-block')) {
                        // Remove from active effects
                        activeEffects.splice(index, 1);
                        return;
                    }
                    
                    // Blue block generates score
                    if (blockType === 'blue-block' && now - effect.lastActivated >= props.interval) {
                        // Update last activation time
                        activeEffects[index].lastActivated = now;
                        
                        // Generate score
                        incrementScore(props.value);
                        
                        // Visual effect
                        const scoreEffect = document.createElement('div');
                        scoreEffect.className = 'score-effect';
                        scoreEffect.textContent = '+' + props.value;
                        
                        const rect = cell.getBoundingClientRect();
                        scoreEffect.style.left = rect.left + rect.width/2 + 'px';
                        scoreEffect.style.top = rect.top + 'px';
                        
                        document.body.appendChild(scoreEffect);
                        
                        setTimeout(() => {
                            scoreEffect.remove();
                        }, 1000);
                    }
                    
                    // Gold block spawns coins
                    if (blockType === 'gold-block' && now - effect.lastActivated >= props.interval) {
                        // Update last activation time
                        activeEffects[index].lastActivated = now;
                        
                        // Check if coin spawns (based on chance)
                        if (Math.random() < props.chance) {
                            // Generate score
                            incrementScore(props.value);
                            
                            // Visual effect - spawn a coin
                            const coinEffect = document.createElement('div');
                            coinEffect.className = 'coin-effect';
                            coinEffect.innerHTML = '<i class="fas fa-coins"></i>';
                            
                            const rect = cell.getBoundingClientRect();
                            coinEffect.style.left = rect.left + rect.width/2 + 'px';
                            coinEffect.style.top = rect.top + 'px';
                            
                            document.body.appendChild(coinEffect);
                            
                            setTimeout(() => {
                                coinEffect.remove();
                            }, 1500);
                        }
                    }
                    
                    // Red block energy boost
                    if (blockType === 'red-block' && now - effect.lastActivated >= 3000) { // Every 3 seconds
                        // Update last activation time
                        activeEffects[index].lastActivated = now;
                        
                        // Show energy pulse animation
                        cell.classList.add('energy-pulse');
                        setTimeout(() => {
                            cell.classList.remove('energy-pulse');
                        }, 1000);
                        
                        // Apply boost to nearby blocks (in actual implementation would boost their effects)
                        const radius = props.radius;
                        for (let r = effect.row - radius; r <= effect.row + radius; r++) {
                            for (let c = effect.col - radius; c <= effect.col + radius; c++) {
                                // Skip if out of bounds or same as energy block
                                if (r < 0 || r >= 20 || c < 0 || c >= 20 || (r === effect.row && c === effect.col)) {
                                    continue;
                                }
                                
                                const targetCell = document.querySelector(`.grid-cell[data-row="${r}"][data-col="${c}"]`);
                                if (targetCell && targetCell.classList.contains('has-block')) {
                                    // Add temporary boost effect
                                    targetCell.classList.add('energy-boosted');
                                    setTimeout(() => {
                                        targetCell.classList.remove('energy-boosted');
                                    }, 2000);
                                }
                            }
                        }
                    }
                });
            }

            function refreshInventory() {
                // Clear current inventory display
                inventoryBlocksContainer.innerHTML = '';
                
                // Add blocks to inventory display
                for (let blockType in blockInventory) {
                    if (blockInventory[blockType].count > 0) {
                        const blockElement = document.createElement('div');
                        blockElement.classList.add('inventory-block');
                        blockElement.style.backgroundColor = blockInventory[blockType].color;
                        blockElement.setAttribute('data-block-type', blockType);
                        
                        // Add special indicator based on block type
                        const blockIcon = document.createElement('div');
                        blockIcon.classList.add('block-icon');
                        
                        if (blockType === 'red-block') {
                            blockIcon.innerHTML = '<i class="fas fa-bolt"></i>';
                        } else if (blockType === 'blue-block') {
                            blockIcon.innerHTML = '<i class="fas fa-cog"></i>';
                        } else if (blockType === 'gold-block') {
                            blockIcon.innerHTML = '<i class="fas fa-coins"></i>';
                        } else if (blockType === 'purple-block') {
                            blockIcon.innerHTML = '<i class="fas fa-star"></i>';
                        } else if (blockType === 'green-block') {
                            blockIcon.innerHTML = '<i class="fas fa-seedling"></i>';
                        } else if (blockType === 'black-block') {
                            blockIcon.innerHTML = '<i class="fas fa-shield-alt"></i>';
                        }
                        
                        blockElement.appendChild(blockIcon);
                        
                        // Add count badge
                        const countElement = document.createElement('div');
                        countElement.classList.add('inventory-count');
                        countElement.textContent = blockInventory[blockType].count;
                        blockElement.appendChild(countElement);
                        
                        // Add tooltip with description
                        blockElement.addEventListener('mouseover', function() {
                            const tooltip = document.createElement('div');
                            tooltip.className = 'block-tooltip inventory-tooltip';
                            tooltip.innerHTML = `<strong>${blockProperties[blockType].name}</strong><br>${blockProperties[blockType].description}`;
                            
                            const rect = this.getBoundingClientRect();
                            tooltip.style.left = rect.left + 'px';
                            tooltip.style.top = (rect.bottom + 5) + 'px';
                            
                            document.body.appendChild(tooltip);
                        });
                        
                        blockElement.addEventListener('mouseout', function() {
                            const tooltip = document.querySelector('.inventory-tooltip');
                            if (tooltip) {
                                tooltip.remove();
                            }
                        });
                        
                        // Handle selection
                        blockElement.addEventListener('click', function() {
                            // Deselect all other blocks
                            document.querySelectorAll('.inventory-block').forEach(block => {
                                block.classList.remove('selected');
                            });
                            
                            // Select this block
                            this.classList.add('selected');
                            selectedBlockType = this.getAttribute('data-block-type');
                        });
                        
                        inventoryBlocksContainer.appendChild(blockElement);
                    }
                }
                
                // If there are no blocks, show a message
                if (inventoryBlocksContainer.children.length === 0) {
                    const emptyMessage = document.createElement('p');
                    emptyMessage.textContent = "No blocks in inventory. Buy some in the Shop!";
                    emptyMessage.style.color = "rgba(255, 255, 255, 0.5)";
                    emptyMessage.style.fontSize = "0.9rem";
                    emptyMessage.style.textAlign = "center";
                    emptyMessage.style.padding = "1rem 0";
                    inventoryBlocksContainer.appendChild(emptyMessage);
                }
            }

            function initializeBuildSlots() {
                buildSlotsContainer.innerHTML = '';
                
                // Find all build slots in localStorage
                let existingSlots = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('buildStructure_')) {
                        const slotNumber = parseInt(key.replace('buildStructure_', ''));
                        existingSlots.push(slotNumber);
                    }
                }
                
                // If no slots exist, create a default first slot
                if (existingSlots.length === 0) {
                    existingSlots = [1];
                    buildSlots[1] = [];
                }
                
                // Sort slot numbers
                existingSlots.sort((a, b) => a - b);
                
                // Create elements for each slot
                existingSlots.forEach(slotNumber => {
                    // Get data for this slot
                    const slotData = localStorage.getItem(`buildStructure_${slotNumber}`);
                    let slotName = localStorage.getItem(`buildSlotName_${slotNumber}`) || `Build ${slotNumber}`;
                    
                    // Create the slot element
                    const slotElement = document.createElement('div');
                    slotElement.classList.add('build-slot');
                    slotElement.setAttribute('data-slot', slotNumber);
                    if (slotNumber === currentBuildSlot) {
                        slotElement.classList.add('active');
                    }
                    
                    // Add slot name
                    const nameElement = document.createElement('div');
                    nameElement.classList.add('slot-name');
                    nameElement.textContent = slotName;
                    slotElement.appendChild(nameElement);
                    
                    // Add delete button
                    const deleteButton = document.createElement('div');
                    deleteButton.classList.add('slot-delete');
                    deleteButton.innerHTML = '<i class="fas fa-times"></i>';
                    deleteButton.title = 'Delete this build slot';
                    
                    // Only show delete button on hover
                    slotElement.addEventListener('mouseenter', function() {
                        if (existingSlots.length > 1) { // Don't allow deleting the last slot
                            deleteButton.style.display = 'flex';
                        }
                    });
                    
                    slotElement.addEventListener('mouseleave', function() {
                        deleteButton.style.display = 'none';
                    });
                    
                    // Add click event for delete
                    deleteButton.addEventListener('click', function(e) {
                        e.stopPropagation(); // Prevent slot selection
                        deleteBuildSlot(slotNumber);
                    });
                    
                    slotElement.appendChild(deleteButton);
                    
                    // Add indicator if slot has data
                    if (slotData) {
                        const indicatorElement = document.createElement('div');
                        indicatorElement.classList.add('slot-indicator');
                        indicatorElement.innerHTML = '<i class="fas fa-check"></i>';
                        indicatorElement.title = 'This slot contains a saved build';
                        slotElement.appendChild(indicatorElement);
                    }
                    
                    // Add click event to select slot
                    slotElement.addEventListener('click', function() {
                        const slotNumber = parseInt(this.getAttribute('data-slot'));
                        selectBuildSlot(slotNumber);
                    });
                    
                    buildSlotsContainer.appendChild(slotElement);
                    
                    // Store slot data in memory if it exists
                    if (slotData) {
                        buildSlots[slotNumber] = JSON.parse(slotData);
                    } else {
                        buildSlots[slotNumber] = [];
                    }
                });
                
                // Set current slot to the first one if it's not in the list
                if (!existingSlots.includes(currentBuildSlot)) {
                    currentBuildSlot = existingSlots[0];
                }
                
                // Load the current slot
                loadBuildFromSlot(currentBuildSlot);
            }
            
            function selectBuildSlot(slotNumber) {
                if (slotNumber === currentBuildSlot) return;
                
                // Save current build to current slot
                updateBuildStructure();
                buildSlots[currentBuildSlot] = buildStructure;
                localStorage.setItem(`buildStructure_${currentBuildSlot}`, JSON.stringify(buildStructure));
                
                // Update UI to show new slot as active
                document.querySelectorAll('.build-slot').forEach(slot => {
                    slot.classList.remove('active');
                });
                
                const newSlotElement = document.querySelector(`.build-slot[data-slot="${slotNumber}"]`);
                if (newSlotElement) {
                    newSlotElement.classList.add('active');
                }
                
                // Update current slot and load its build
                currentBuildSlot = slotNumber;
                loadBuildFromSlot(slotNumber);
            }
            
            function loadBuildFromSlot(slotNumber) {
                // Clear the current build
                clearBuild();
                
                // Load the build from the slot if it exists
                if (buildSlots[slotNumber] && buildSlots[slotNumber].length > 0) {
                    buildStructure = buildSlots[slotNumber];
                    
                    // Sort blocks by row so we place from bottom to top
                    const blocksToPlace = [...buildStructure];
                    blocksToPlace.sort((a, b) => b.row - a.row);
                    
                    // Place blocks according to saved structure, respecting physics
                    let placedAny = true;
                    let attempts = 0;
                    const maxAttempts = 5; // Prevent infinite loops
                    
                    while (placedAny && attempts < maxAttempts) {
                        placedAny = false;
                        attempts++;
                        
                        for (let i = 0; i < blocksToPlace.length; i++) {
                            if (blocksToPlace[i].placed) continue;
                            
                            const block = blocksToPlace[i];
                            
                            // Check if we have this block in inventory
                            if (blockInventory[block.blockType].count > 0) {
                                const row = block.row;
                                const col = block.col;
                                
                                // Check if we can place it according to physics rules
                                if (canPlaceBlockAt(row, col)) {
                                    const cell = document.querySelector(`.grid-cell[data-row="${row}"][data-col="${col}"]`);
                                    if (cell) {
                                        placeBlock(cell, block.blockType);
                                        blocksToPlace[i].placed = true;
                                        placedAny = true;
                                    }
                                }
                            }
                        }
                    }
                    
                    // If some blocks weren't placed, let the user know
                    const unplacedBlocks = blocksToPlace.filter(block => !block.placed).length;
                    if (unplacedBlocks > 0) {
                        alert(`Loaded build but couldn't place ${unplacedBlocks} blocks due to physics constraints.`);
                    }
                }
            }
            
            function renameBuildSlot() {
                // Create modal for renaming
                const modal = document.createElement('div');
                modal.classList.add('rename-slot-modal');
                
                const modalContent = document.createElement('div');
                modalContent.classList.add('rename-slot-content');
                
                // Get current slot name
                const currentSlotElement = document.querySelector(`.build-slot[data-slot="${currentBuildSlot}"]`);
                const currentSlotName = currentSlotElement.querySelector('.slot-name').textContent;
                
                modalContent.innerHTML = `
                    <h3>Rename Build Slot</h3>
                    <p>Enter a new name for Build Slot ${currentBuildSlot}</p>
                    <input type="text" id="slot-name-input" value="${currentSlotName}" maxlength="20" placeholder="Enter slot name...">
                    <div class="rename-slot-buttons">
                        <button class="rename-cancel">Cancel</button>
                        <button class="rename-confirm">Save</button>
                    </div>
                `;
                
                modal.appendChild(modalContent);
                document.body.appendChild(modal);
                
                // Focus the input
                setTimeout(() => {
                    document.getElementById('slot-name-input').focus();
                }, 100);
                
                // Handle cancel button
                modal.querySelector('.rename-cancel').addEventListener('click', function() {
                    modal.remove();
                });
                
                // Handle confirm button
                modal.querySelector('.rename-confirm').addEventListener('click', function() {
                    const newName = document.getElementById('slot-name-input').value.trim();
                    if (newName) {
                        // Update the slot name in localStorage
                        localStorage.setItem(`buildSlotName_${currentBuildSlot}`, newName);
                        
                        // Update the UI
                        const slotNameElement = currentSlotElement.querySelector('.slot-name');
                        slotNameElement.textContent = newName;
                    }
                    modal.remove();
                });
            }

            function updateBuildStructure() {
                buildStructure = [];
                
                // Iterate through all cells and record blocks
                document.querySelectorAll('.grid-cell.has-block').forEach(cell => {
                    const row = parseInt(cell.getAttribute('data-row'));
                    const col = parseInt(cell.getAttribute('data-col'));
                    const blockType = cell.getAttribute('data-block-type');
                    
                    buildStructure.push({
                        row: row,
                        col: col,
                        blockType: blockType
                    });
                });
                
                // Save to current slot
                buildSlots[currentBuildSlot] = buildStructure;
            }

            function clearBuild() {
                // Return all blocks to inventory
                document.querySelectorAll('.grid-cell.has-block').forEach(cell => {
                    const blockType = cell.getAttribute('data-block-type');
                    blockInventory[blockType].count++;
                    
                    // Reset the cell
                    cell.style.backgroundColor = '';
                    cell.classList.remove('has-block');
                    cell.removeAttribute('data-block-type');
                });
                
                // Update inventory display
                refreshInventory();
                
                // Clear build structure
                buildStructure = [];
                buildSlots[currentBuildSlot] = [];
            }

            function saveBuild() {
                // Update structure before saving
                updateBuildStructure();
                
                // Save to localStorage with the current slot
                localStorage.setItem(`buildStructure_${currentBuildSlot}`, JSON.stringify(buildStructure));
                
                // Add indicator to the slot if it doesn't have one
                const slotElement = document.querySelector(`.build-slot[data-slot="${currentBuildSlot}"]`);
                if (!slotElement.querySelector('.slot-indicator')) {
                    const indicatorElement = document.createElement('div');
                    indicatorElement.classList.add('slot-indicator');
                    indicatorElement.innerHTML = '<i class="fas fa-check"></i>';
                    indicatorElement.title = 'This slot contains a saved build';
                    slotElement.appendChild(indicatorElement);
                }
                
                alert(`Build saved successfully to slot ${currentBuildSlot}!`);
            }

            function loadBuild() {
                // Get saved structure from the current slot
                const savedStructure = localStorage.getItem(`buildStructure_${currentBuildSlot}`);
                
                if (!savedStructure) {
                    alert(`No saved build found in slot ${currentBuildSlot}.`);
                    return;
                }
                
                // Clear current build
                clearBuild();
                
                // Parse saved structure
                const savedBlocks = JSON.parse(savedStructure);
                
                // Update buildStructure and buildSlots
                buildStructure = savedBlocks;
                buildSlots[currentBuildSlot] = savedBlocks;
                
                // Sort blocks by row so we place from bottom to top
                savedBlocks.sort((a, b) => b.row - a.row);
                
                // Place blocks according to saved structure, respecting physics
                let placedAny = true;
                let attempts = 0;
                const maxAttempts = 5; // Prevent infinite loops
                
                while (placedAny && attempts < maxAttempts) {
                    placedAny = false;
                    attempts++;
                    
                    for (let i = 0; i < savedBlocks.length; i++) {
                        if (savedBlocks[i].placed) continue;
                        
                        const block = savedBlocks[i];
                        
                        // Check if we have this block in inventory
                        if (blockInventory[block.blockType].count > 0) {
                            const row = block.row;
                            const col = block.col;
                            
                            // Check if we can place it according to physics rules
                            if (canPlaceBlockAt(row, col)) {
                                const cell = document.querySelector(`.grid-cell[data-row="${row}"][data-col="${col}"]`);
                                if (cell) {
                                    placeBlock(cell, block.blockType);
                                    savedBlocks[i].placed = true;
                                    placedAny = true;
                                }
                            }
                        }
                    }
                }
                
                // If some blocks weren't placed, let the user know
                const unplacedBlocks = savedBlocks.filter(block => !block.placed).length;
                if (unplacedBlocks > 0) {
                    alert(`Loaded build but couldn't place ${unplacedBlocks} blocks due to physics constraints.`);
                }
            }

            function createParticle() {
                const particle = document.createElement('div');
                particle.classList.add('particle');
                
                // Random size between 2 and 5px
                const size = Math.random() * 3 + 2;
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                
                // Random position
                particle.style.left = `${Math.random() * 100}vw`;
                particle.style.top = `${Math.random() * 100}vh`;
                
                // Random opacity
                particle.style.opacity = Math.random() * 0.5 + 0.1;
                
                particles.appendChild(particle);
            }

            // Calculate CPS (Clicks Per Second)
            function calculateCPS() {
                const now = Date.now();
                // Keep only clicks from the last 5 seconds
                clickTimes = clickTimes.filter(time => now - time < 5000);
                
                if (clickTimes.length > 0) {
                    const timeSpan = (now - clickTimes[0]) / 1000; // in seconds
                    const cps = timeSpan > 0 ? clickTimes.length / timeSpan : 0;
                    
                    // Update CPS display
                    cpsElement.textContent = cps.toFixed(1);
                    
                    // Update best CPS if current is better
                    if (cps > bestCps && clickTimes.length >= 5) { // Only count if we have at least 5 clicks
                        bestCps = cps;
                        bestCpsElement.textContent = bestCps.toFixed(1);
                        
                        // Check for CPS achievement
                        checkAchievements();
                    }
                } else {
                    cpsElement.textContent = '0.0';
                }
                
                // Schedule the next update
                setTimeout(calculateCPS, 200);
            }

            // Start CPS calculation
            calculateCPS();

            // Sidebar navigation
            menuItems.forEach(item => {
                item.addEventListener('click', function() {
                    if (this.classList.contains('coming-soon')) {
                        // Just show the coming soon section
                        const sectionName = this.getAttribute('data-section');
                        showSection(sectionName);
                        
                        // Mark as active if it's not already
                        if (!this.classList.contains('active')) {
                            menuItems.forEach(mi => mi.classList.remove('active'));
                            this.classList.add('active');
                        }
                    } else {
                        // Toggle active state
                        menuItems.forEach(mi => mi.classList.remove('active'));
                        this.classList.add('active');
                        
                        // Show corresponding section
                        const sectionName = this.getAttribute('data-section');
                        showSection(sectionName);
                        
                        // If this is the updates section, remove the new badge if it exists
                        if (sectionName === 'updates') {
                            const newBadge = this.querySelector('.update-new-badge');
                            if (newBadge) {
                                newBadge.remove();
                            }
                        }
                    }
                });
            });
            
            // Add "New" badge to Updates menu if the version is new
            function checkForNewUpdates() {
                if (gameVersion.isNew(7)) { // Show badge if version is less than 7 days old
                    const updatesMenuItem = document.querySelector('.menu-item[data-section="updates"]');
                    if (updatesMenuItem && !updatesMenuItem.querySelector('.update-new-badge')) {
                        const newBadge = document.createElement('div');
                        newBadge.className = 'update-new-badge';
                        newBadge.textContent = 'New';
                        updatesMenuItem.appendChild(newBadge);
                    }
                }
            }
            
            // Run new updates check on page load
            checkForNewUpdates();
            
            function showSection(sectionName) {
                // Hide all sections first
                gameSections.forEach(section => {
                    section.classList.add('hidden');
                });
                
                // Show the selected section
                document.getElementById(sectionName + '-section').classList.remove('hidden');
            }

            // Shop functionality
            shopItems.forEach(item => {
                const id = item.getAttribute('data-id');
                const priceElement = item.querySelector('.price-value');
                const levelElement = item.querySelector('.level-value');
                const multiplierElement = item.querySelector('.multiplier-value');
                
                item.addEventListener('click', function() {
                    const price = parseInt(this.getAttribute('data-price'));
                    const level = parseInt(this.getAttribute('data-level'));
                    const increment = parseFloat(this.getAttribute('data-increment'));
                    
                    if (score >= price) {
                        // Deduct the cost
                        score -= price;
                        scoreElement.textContent = score;
                        
                        // Increase the level
                        const newLevel = level + 1;
                        this.setAttribute('data-level', newLevel);
                        levelElement.textContent = newLevel;
                        
                        // Add to block inventory
                        blockInventory[id].count++;
                        
                        // Track purchase for achievements
                        achievements.buyCount++;
                        saveAchievements();
                        checkAchievements();
                        
                        // Update the multiplier based on the item
                        if (id === 'red-block') {
                            clickMultiplier += increment;
                            multiplierElement.textContent = clickMultiplier;
                        } else if (id === 'blue-block') {
                            autoClickValue += increment;
                            multiplierElement.textContent = autoClickValue.toFixed(1);
                            
                            // Clear existing interval and set up new one
                            clearInterval(autoClickerInterval);
                            if (autoClickValue > 0) {
                                autoClickerInterval = setInterval(function() {
                                    incrementScore(clickMultiplier);
                                }, 1000 / autoClickValue);
                            }
                        } else if (id === 'gold-block') {
                            bonusClickChance += increment;
                            multiplierElement.textContent = bonusClickChance;
                        }
                        
                        // Increase the price for next purchase
                        const newPrice = Math.floor(price * 1.5);
                        this.setAttribute('data-price', newPrice);
                        priceElement.textContent = newPrice;
                        
                        // Visual feedback
                        item.classList.add('item-purchased');
                        setTimeout(() => {
                            item.classList.remove('item-purchased');
                        }, 300);
                        
                        // Update inventory display
                        refreshInventory();
                        
                        // Update shop item price indicators
                        updateShopPriceIndicators();
                    } else {
                        // Not enough score - visual feedback
                        item.classList.add('item-cannot-afford');
                        setTimeout(() => {
                            item.classList.remove('item-cannot-afford');
                        }, 300);
                    }
                });
            });
            
            function incrementScore(amount) {
                // Apply the base amount
                score += amount;
                
                // Update total score for achievements
                achievements.totalScore += amount;
                achievements.highestScore = Math.max(achievements.highestScore, score);
                
                // Check for bonus clicks if applicable
                if (bonusClickChance > 0 && Math.random() * 100 < bonusClickChance) {
                    const bonus = Math.ceil(amount * 2); // Double the click value as bonus
                    score += bonus;
                    achievements.totalScore += bonus;
                    
                    // Unlock the bonus click achievement
                    if (!achievementsList.find(a => a.id === "first_bonus").unlocked) {
                        unlockSpecialAchievement("first_bonus");
                    }
                    
                    // Play bonus sound
                    playSound('bonus');
                    
                    // Visual feedback for bonus
                    const bonusIndicator = document.createElement('div');
                    bonusIndicator.className = 'bonus-indicator';
                    bonusIndicator.textContent = '+' + bonus;
                    
                    const rect = clicker.getBoundingClientRect();
                    bonusIndicator.style.left = rect.left + rect.width / 2 + 'px';
                    bonusIndicator.style.top = rect.top + 'px';
                    
                    document.body.appendChild(bonusIndicator);
                    
                    setTimeout(() => {
                        bonusIndicator.remove();
                    }, 1000);
                }
                
                scoreElement.textContent = score;
                
                // Update shop item price indicators
                updateShopPriceIndicators();
                
                // Check score-related achievements
                checkAchievements();
            }
            
            // Update shop item price indicators to show which items can be afforded
            function updateShopPriceIndicators() {
                shopItems.forEach(item => {
                    const price = parseInt(item.getAttribute('data-price'));
                    const priceElement = item.querySelector('.shop-item-price');
                    
                    if (score >= price) {
                        priceElement.classList.add('can-afford');
                    } else {
                        priceElement.classList.remove('can-afford');
                    }
                });
            }

            // Add click effect
            clicker.addEventListener('click', function(e) {
                // Play click sound
                playSound('click');
                
                // Count the click for achievements
                achievements.clickCount++;
                
                // Increment score by click multiplier
                incrementScore(clickMultiplier);
                
                // Record click time for CPS calculation
                const now = Date.now();
                clickTimes.push(now);
                
                // Visual feedback - scale animation
                scoreElement.style.transform = 'scale(1.2)';
                setTimeout(() => {
                    scoreElement.style.transform = 'scale(1)';
                }, 100);
                
                // Create ripple effect
                const ripple = document.createElement('div');
                ripple.classList.add('click-ripple');
                
                const rect = clicker.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                ripple.style.left = `${x}px`;
                ripple.style.top = `${y}px`;
                
                clicker.appendChild(ripple);
                
                // Remove ripple after animation completes
                setTimeout(() => {
                    ripple.remove();
                }, 800);
                
                // Check click-related achievements
                checkAchievements();
                
                // Show an interstitial ad less frequently with a time-based cooldown
                if (score % 100 === 0 && score > 0) {
                    // Check if at least 5 minutes have passed since the last ad
                    const currentTime = Date.now();
                    const lastAdTime = localStorage.getItem('lastAdTime') || 0;
                    const timeSinceLastAd = currentTime - lastAdTime;
                    
                    // 5 minutes = 300000 milliseconds
                    if (timeSinceLastAd >= 300000) {
                        localStorage.setItem('lastAdTime', currentTime);
                        alert("You've reached " + score + " clicks! In a real implementation, this could trigger a full-screen ad.");
                    }
                }
            });
            
            // Builder control buttons
            clearBuildBtn.addEventListener('click', clearBuild);
            saveBuildBtn.addEventListener('click', saveBuild);
            loadBuildBtn.addEventListener('click', loadBuild);
            renameSlotBtn.addEventListener('click', renameBuildSlot);
            addSlotBtn.addEventListener('click', addBuildSlot);
            
            // Settings buttons
            document.getElementById('save-settings').addEventListener('click', saveSettings);
            document.getElementById('reset-settings').addEventListener('click', resetSettings);
            document.getElementById('export-game').addEventListener('click', showExportModal);
            document.getElementById('import-game').addEventListener('click', showImportModal);
            
            // Volume slider
            document.getElementById('sound-volume').addEventListener('input', function() {
                const volumeValue = this.value;
                document.querySelector('.volume-value').textContent = volumeValue + '%';
            });
            
            // Live theme preview
            document.getElementById('theme-selector').addEventListener('change', function() {
                const theme = this.value;
                document.body.className = '';
                if (theme !== 'default') {
                    document.body.classList.add('theme-' + theme);
                }
            });
            
            // Live particles toggle
            document.getElementById('toggle-particles').addEventListener('change', function() {
                const particlesContainer = document.getElementById('particles');
                particlesContainer.style.display = this.checked ? 'block' : 'none';
            });
            
            // Initialize with the build section visible
            showSection('build');

            // Check if a block can be removed
            function canRemoveBlock(cell) {
                // Don't allow removing ground
                if (cell.classList.contains('ground')) {
                    return false;
                }
                
                const row = parseInt(cell.getAttribute('data-row'));
                const col = parseInt(cell.getAttribute('data-col'));
                
                // Check if there's a block above (can't remove if supporting another block)
                const cellAbove = document.querySelector(`.grid-cell[data-row="${row - 1}"][data-col="${col}"]`);
                return !(cellAbove && cellAbove.classList.contains('has-block'));
            }

            // Remove a block
            function removeBlock(cell) {
                const blockType = cell.getAttribute('data-block-type');
                
                // Play remove sound
                playSound('remove');
                
                // Return the block to inventory
                blockInventory[blockType].count++;
                
                // Track block removal for achievements
                achievements.blocksRemoved++;
                saveAchievements();
                
                // Remove any special classes
                cell.classList.remove('energy-emitter', 'score-generator', 'coin-spawner', 
                                    'multiplier', 'regenerative', 'reinforced',
                                    'energy-pulse', 'energy-boosted', 'multiplier-boosted');
                
                // Reset the cell
                cell.style.backgroundColor = '';
                cell.classList.remove('has-block');
                cell.removeAttribute('data-block-type');
                
                // Remove from active effects
                const row = parseInt(cell.getAttribute('data-row'));
                const col = parseInt(cell.getAttribute('data-col'));
                
                activeEffects = activeEffects.filter(effect => 
                    !(effect.row === row && effect.col === col)
                );
                
                // Update inventory display
                refreshInventory();
                
                // Save the current structure
                updateBuildStructure();
            }

            function addBuildSlot() {
                // Get the highest slot number currently in use
                const slotElements = document.querySelectorAll('.build-slot');
                let highestSlotNumber = 0;
                
                slotElements.forEach(slotElement => {
                    const slotNumber = parseInt(slotElement.getAttribute('data-slot'));
                    if (slotNumber > highestSlotNumber) {
                        highestSlotNumber = slotNumber;
                    }
                });
                
                // Create a new slot with the next number
                const newSlotNumber = highestSlotNumber + 1;
                const slotName = `Build ${newSlotNumber}`;
                
                // Create the slot element
                const slotElement = document.createElement('div');
                slotElement.classList.add('build-slot');
                slotElement.setAttribute('data-slot', newSlotNumber);
                
                // Add slot name
                const nameElement = document.createElement('div');
                nameElement.classList.add('slot-name');
                nameElement.textContent = slotName;
                slotElement.appendChild(nameElement);
                
                // Save the default name
                localStorage.setItem(`buildSlotName_${newSlotNumber}`, slotName);
                
                // Add click event to select slot
                slotElement.addEventListener('click', function() {
                    const slotNumber = parseInt(this.getAttribute('data-slot'));
                    selectBuildSlot(slotNumber);
                });
                
                // Initialize this slot with an empty build
                buildSlots[newSlotNumber] = [];
                
                // Add to the container
                buildSlotsContainer.appendChild(slotElement);
                
                // Switch to the new slot
                selectBuildSlot(newSlotNumber);
                
                // Prompt user to name the new slot
                setTimeout(() => {
                    renameBuildSlot();
                }, 300);
            }

            function deleteBuildSlot(slotNumber) {
                // Confirm before deleting
                if (!confirm(`Are you sure you want to delete this build slot?\nThis action cannot be undone.`)) {
                    return;
                }
                
                // Find another slot to switch to
                let newSlotNumber = null;
                const slotElements = document.querySelectorAll('.build-slot');
                
                for (let i = 0; i < slotElements.length; i++) {
                    const thisSlot = parseInt(slotElements[i].getAttribute('data-slot'));
                    if (thisSlot !== slotNumber) {
                        newSlotNumber = thisSlot;
                        break;
                    }
                }
                
                // If we found another slot, switch to it first
                if (newSlotNumber !== null) {
                    // If the slot we're deleting is the current slot, switch to another one first
                    if (currentBuildSlot === slotNumber) {
                        selectBuildSlot(newSlotNumber);
                    }
                    
                    // Remove the slot from localStorage
                    localStorage.removeItem(`buildStructure_${slotNumber}`);
                    localStorage.removeItem(`buildSlotName_${slotNumber}`);
                    
                    // Remove the slot from memory
                    delete buildSlots[slotNumber];
                    
                    // Refresh the slots UI
                    initializeBuildSlots();
                } else {
                    // This is the last slot, don't delete it
                    alert("You can't delete the last build slot.");
                }
            }

            // Load and apply saved settings
            function loadSettings() {
                // Try to load settings from localStorage
                const savedSettings = localStorage.getItem('gameSettings');
                if (savedSettings) {
                    try {
                        const parsedSettings = JSON.parse(savedSettings);
                        
                        // Deep merge with default settings to ensure all properties exist
                        if (parsedSettings.visual) {
                            gameSettings.visual = {
                                ...gameSettings.visual,
                                ...parsedSettings.visual
                            };
                        }
                        
                        if (parsedSettings.sound) {
                            gameSettings.sound = {
                                ...gameSettings.sound,
                                ...parsedSettings.sound
                            };
                        }
                        
                        if (parsedSettings.gameplay) {
                            gameSettings.gameplay = {
                                ...gameSettings.gameplay,
                                ...parsedSettings.gameplay
                            };
                        }
                        
                        if (parsedSettings.accessibility) {
                            gameSettings.accessibility = {
                                ...gameSettings.accessibility,
                                ...parsedSettings.accessibility
                            };
                        }
                    } catch (e) {
                        console.error('Error parsing saved settings:', e);
                    }
                }
                
                // Apply settings to UI elements
                applySettingsToUI();
                
                // Apply visual settings
                applyVisualSettings();
                
                // Apply accessibility settings
                applyAccessibilitySettings();
                
                // Start auto-save timer with new settings
                startAutoSave();
                
                console.log('Settings loaded:', gameSettings);
            }
            
            // Apply settings values to UI controls
            function applySettingsToUI() {
                // Visual settings
                document.getElementById('toggle-particles').checked = gameSettings.visual.particles;
                document.getElementById('theme-selector').value = gameSettings.visual.theme;
                
                // Sound settings
                document.getElementById('toggle-sound').checked = gameSettings.sound.enabled;
                document.getElementById('sound-volume').value = gameSettings.sound.volume;
                document.querySelector('.volume-value').textContent = gameSettings.sound.volume + '%';
                
                // Gameplay settings
                document.getElementById('difficulty-selector').value = gameSettings.gameplay.physics;
                document.getElementById('auto-save').checked = gameSettings.gameplay.autoSave;
                document.getElementById('auto-save-interval').value = gameSettings.gameplay.autoSaveInterval.toString();
                
                // Accessibility settings
                document.getElementById('text-size').value = gameSettings.accessibility.textSize;
                document.getElementById('high-contrast').checked = gameSettings.accessibility.highContrast;
                document.getElementById('reduce-motion').checked = gameSettings.accessibility.reduceMotion;
            }
            
            // Apply visual settings to the game
            function applyVisualSettings() {
                // Handle particles
                const particlesContainer = document.getElementById('particles');
                if (gameSettings.visual.particles) {
                    particlesContainer.style.display = 'block';
                } else {
                    particlesContainer.style.display = 'none';
                }
                
                // Handle theme
                document.body.className = ''; // Reset theme classes
                if (gameSettings.visual.theme !== 'default') {
                    document.body.classList.add('theme-' + gameSettings.visual.theme);
                }
                
                // If accessibility settings are also applied, re-apply them
                if (gameSettings.accessibility.textSize !== 'normal') {
                    document.body.classList.add('text-' + (gameSettings.accessibility.textSize === 'extra-large' ? 'xl' : 'large'));
                }
                
                if (gameSettings.accessibility.highContrast) {
                    document.body.classList.add('high-contrast');
                }
                
                if (gameSettings.accessibility.reduceMotion) {
                    document.body.classList.add('reduce-motion');
                }
            }
            
            // Apply accessibility settings
            function applyAccessibilitySettings() {
                // Text size
                document.body.classList.remove('text-large', 'text-xl');
                if (gameSettings.accessibility.textSize === 'large') {
                    document.body.classList.add('text-large');
                } else if (gameSettings.accessibility.textSize === 'extra-large') {
                    document.body.classList.add('text-xl');
                }
                
                // High contrast
                if (gameSettings.accessibility.highContrast) {
                    document.body.classList.add('high-contrast');
                } else {
                    document.body.classList.remove('high-contrast');
                }
                
                // Reduced motion
                if (gameSettings.accessibility.reduceMotion) {
                    document.body.classList.add('reduce-motion');
                } else {
                    document.body.classList.remove('reduce-motion');
                }
            }
            
            // Save current settings
            function saveSettings() {
                // Update settings object from UI
                updateSettingsFromUI();
                
                // Save to localStorage
                localStorage.setItem('gameSettings', JSON.stringify(gameSettings));
                
                // Apply settings
                applyVisualSettings();
                applyAccessibilitySettings();
                startAutoSave(); // Restart auto-save with potentially new interval
                
                // Show confirmation message
                const confirmationMessage = document.createElement('div');
                confirmationMessage.className = 'settings-confirmation';
                confirmationMessage.textContent = 'Settings saved successfully!';
                document.querySelector('.settings-actions').appendChild(confirmationMessage);
                
                // Remove confirmation after 3 seconds
                setTimeout(() => {
                    confirmationMessage.remove();
                }, 3000);
            }
            
            // Update settings object from UI controls
            function updateSettingsFromUI() {
                // Visual settings
                gameSettings.visual.particles = document.getElementById('toggle-particles').checked;
                gameSettings.visual.theme = document.getElementById('theme-selector').value;
                
                // Sound settings
                gameSettings.sound.enabled = document.getElementById('toggle-sound').checked;
                gameSettings.sound.volume = parseInt(document.getElementById('sound-volume').value);
                
                // Gameplay settings
                gameSettings.gameplay.physics = document.getElementById('difficulty-selector').value;
                gameSettings.gameplay.autoSave = document.getElementById('auto-save').checked;
                gameSettings.gameplay.autoSaveInterval = parseInt(document.getElementById('auto-save-interval').value);
                
                // Accessibility settings
                gameSettings.accessibility.textSize = document.getElementById('text-size').value;
                gameSettings.accessibility.highContrast = document.getElementById('high-contrast').checked;
                gameSettings.accessibility.reduceMotion = document.getElementById('reduce-motion').checked;
            }
            
            // Reset settings to default
            function resetSettings() {
                if (confirm('Are you sure you want to reset all settings to default?')) {
                    // Reset to default values
                    gameSettings = {
                        visual: {
                            particles: true,
                            theme: 'default'
                        },
                        sound: {
                            enabled: true,
                            volume: 80
                        },
                        gameplay: {
                            physics: 'normal',
                            autoSave: true,
                            autoSaveInterval: 60000
                        },
                        accessibility: {
                            textSize: 'normal',
                            highContrast: false,
                            reduceMotion: false
                        }
                    };
                    
                    // Apply to UI and save
                    applySettingsToUI();
                    saveSettings();
                }
            }
            
            // Handle auto-save functionality
            function startAutoSave() {
                // Clear any existing timer
                if (autoSaveTimer) {
                    clearInterval(autoSaveTimer);
                    autoSaveTimer = null;
                }
                
                // Start a new timer if auto-save is enabled
                if (gameSettings.gameplay.autoSave) {
                    autoSaveTimer = setInterval(() => {
                        // Auto-save the current build
                        if (buildStructure.length > 0) {
                            updateBuildStructure();
                            localStorage.setItem(`buildStructure_${currentBuildSlot}`, JSON.stringify(buildStructure));
                            
                            // Update indicator if needed
                            const slotElement = document.querySelector(`.build-slot[data-slot="${currentBuildSlot}"]`);
                            if (slotElement && !slotElement.querySelector('.slot-indicator')) {
                                const indicatorElement = document.createElement('div');
                                indicatorElement.classList.add('slot-indicator');
                                indicatorElement.innerHTML = '<i class="fas fa-check"></i>';
                                indicatorElement.title = 'This slot contains a saved build';
                                slotElement.appendChild(indicatorElement);
                            }
                            
                            // Show auto-save indicator
                            const saveIndicator = document.createElement('div');
                            saveIndicator.className = 'auto-save-indicator';
                            saveIndicator.innerHTML = '<i class="fas fa-save"></i> Auto-saved';
                            document.body.appendChild(saveIndicator);
                            
                            // Remove indicator after 2 seconds
                            setTimeout(() => {
                                saveIndicator.remove();
                            }, 2000);
                        }
                    }, gameSettings.gameplay.autoSaveInterval);
                }
            }
            
            // Show export modal
            function showExportModal() {
                // Create the export modal
                const modal = document.createElement('div');
                modal.className = 'import-export-modal';
                
                // Generate the save data
                const saveData = generateSaveData();
                
                modal.innerHTML = `
                    <div class="import-export-content">
                        <h3><i class="fas fa-file-export"></i> Export Game Data</h3>
                        <p>Copy the code below to save your game data:</p>
                        <textarea id="export-code" readonly>${saveData}</textarea>
                        <div class="copy-hint" id="copy-hint">Copied to clipboard!</div>
                        <div class="import-export-buttons">
                            <button class="settings-btn" id="copy-export">Copy to Clipboard</button>
                            <button class="settings-btn" id="close-export">Close</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Select the text automatically
                const exportCode = document.getElementById('export-code');
                exportCode.select();
                
                // Copy to clipboard button
                document.getElementById('copy-export').addEventListener('click', function() {
                    exportCode.select();
                    document.execCommand('copy');
                    
                    // Show confirmation
                    const copyHint = document.getElementById('copy-hint');
                    copyHint.style.display = 'block';
                    
                    setTimeout(() => {
                        copyHint.style.display = 'none';
                    }, 2000);
                });
                
                // Close button
                document.getElementById('close-export').addEventListener('click', function() {
                    modal.remove();
                });
            }
            
            // Show import modal
            function showImportModal() {
                // Create the import modal
                const modal = document.createElement('div');
                modal.className = 'import-export-modal';
                
                modal.innerHTML = `
                    <div class="import-export-content">
                        <h3><i class="fas fa-file-import"></i> Import Game Data</h3>
                        <p>Paste your saved game code below:</p>
                        <textarea id="import-code" placeholder="Paste your save code here..."></textarea>
                        <div class="import-alert" id="import-alert">
                            <i class="fas fa-exclamation-triangle"></i> Invalid save code. Please check and try again.
                        </div>
                        <div class="import-export-buttons">
                            <button class="settings-btn" id="close-import">Cancel</button>
                            <button class="settings-btn settings-btn-primary" id="confirm-import">Import</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Focus the textarea
                setTimeout(() => {
                    document.getElementById('import-code').focus();
                }, 100);
                
                // Close button
                document.getElementById('close-import').addEventListener('click', function() {
                    modal.remove();
                });
                
                // Import button
                document.getElementById('confirm-import').addEventListener('click', function() {
                    const importCode = document.getElementById('import-code').value.trim();
                    const importAlert = document.getElementById('import-alert');
                    
                    if (!importCode) {
                        importAlert.style.display = 'block';
                        importAlert.textContent = 'Please enter a save code.';
                        return;
                    }
                    
                    try {
                        const success = loadSaveData(importCode);
                        
                        if (success) {
                            modal.remove();
                            // Show success message
                            const successMessage = document.createElement('div');
                            successMessage.className = 'auto-save-indicator';
                            successMessage.innerHTML = '<i class="fas fa-check-circle"></i> Game data imported successfully!';
                            document.body.appendChild(successMessage);
                            
                            setTimeout(() => {
                                successMessage.remove();
                            }, 3000);
                        } else {
                            importAlert.style.display = 'block';
                            importAlert.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Invalid or corrupted save code.';
                        }
                    } catch (e) {
                        console.error('Error importing data:', e);
                        importAlert.style.display = 'block';
                        importAlert.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error importing data: ' + e.message;
                    }
                });
            }
            
            // Generate save data
            function generateSaveData() {
                // Collect all game data
                const gameData = {
                    // Game state
                    score: score,
                    clickMultiplier: clickMultiplier,
                    autoClickValue: autoClickValue,
                    bonusClickChance: bonusClickChance,
                    bestCps: bestCps,
                    
                    // Inventory
                    blockInventory: blockInventory,
                    
                    // All build slots
                    buildSlots: {},
                    buildSlotNames: {},
                    currentBuildSlot: currentBuildSlot,
                    
                    // Settings
                    gameSettings: gameSettings,
                    
                    // Achievements
                    achievements: achievements,
                    
                    // Version for future compatibility
                    version: "1.3.2",
                    timestamp: Date.now()
                };
                
                // Collect all build slots from localStorage
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('buildStructure_')) {
                        const slotNumber = key.replace('buildStructure_', '');
                        gameData.buildSlots[slotNumber] = JSON.parse(localStorage.getItem(key));
                    }
                    if (key.startsWith('buildSlotName_')) {
                        const slotNumber = key.replace('buildSlotName_', '');
                        gameData.buildSlotNames[slotNumber] = localStorage.getItem(key);
                    }
                }
                
                // Convert to JSON and then Base64 encode
                const jsonString = JSON.stringify(gameData);
                return btoa(jsonString);
            }
            
            // Load save data
            function loadSaveData(saveCode) {
                try {
                    // Decode from Base64 and parse the JSON
                    const jsonString = atob(saveCode);
                    const gameData = JSON.parse(jsonString);
                    
                    // Check version for compatibility (in future versions)
                    if (!gameData.version) {
                        console.error('Invalid save format: missing version');
                        return false;
                    }
                    
                    // Import game state
                    score = gameData.score || 0;
                    clickMultiplier = gameData.clickMultiplier || 1;
                    autoClickValue = gameData.autoClickValue || 0;
                    bonusClickChance = gameData.bonusClickChance || 0;
                    bestCps = gameData.bestCps || 0;
                    
                    // Update UI
                    scoreElement.textContent = score;
                    bestCpsElement.textContent = bestCps.toFixed(1);
                    
                    // Import inventory
                    if (gameData.blockInventory) {
                        blockInventory = gameData.blockInventory;
                        refreshInventory();
                    }
                    
                    // Import achievements
                    if (gameData.achievements) {
                        achievements = gameData.achievements;
                        
                        // Update the achievements list with unlocked status
                        achievementsList.forEach(a => {
                            a.unlocked = achievements.unlockedAchievements.includes(a.id);
                        });
                        
                        // Update achievements UI
                        renderAchievements();
                        updateAchievementStats();
                    }
                    
                    // Import settings
                    if (gameData.gameSettings) {
                        gameSettings = gameData.gameSettings;
                        applySettingsToUI();
                        applyVisualSettings();
                        applyAccessibilitySettings();
                    }
                    
                    // Clear all existing build slots
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key.startsWith('buildStructure_') || key.startsWith('buildSlotName_')) {
                            localStorage.removeItem(key);
                        }
                    }
                    
                    // Import build slots
                    if (gameData.buildSlots) {
                        for (const [slotNumber, buildData] of Object.entries(gameData.buildSlots)) {
                            localStorage.setItem(`buildStructure_${slotNumber}`, JSON.stringify(buildData));
                        }
                    }
                    
                    // Import build slot names
                    if (gameData.buildSlotNames) {
                        for (const [slotNumber, name] of Object.entries(gameData.buildSlotNames)) {
                            localStorage.setItem(`buildSlotName_${slotNumber}`, name);
                        }
                    }
                    
                    // Set current build slot
                    currentBuildSlot = gameData.currentBuildSlot || 1;
                    
                    // Refresh build slots UI
                    initializeBuildSlots();
                    
                    // Restart auto-save with new settings
                    startAutoSave();
                    
                    // Re-setup auto-clickers if needed
                    if (autoClickValue > 0) {
                        clearInterval(autoClickerInterval);
                        autoClickerInterval = setInterval(function() {
                            incrementScore(clickMultiplier);
                        }, 1000 / autoClickValue);
                    }
                    
                    // Update shop price indicators based on loaded score
                    updateShopPriceIndicators();
                    
                    return true;
                } catch (e) {
                    console.error('Error loading save data:', e);
                    return false;
                }
            }

            // Initialize achievements
            function initializeAchievements() {
                // Check localStorage for saved achievements
                const savedAchievements = localStorage.getItem('achievements');
                if (savedAchievements) {
                    try {
                        achievements = JSON.parse(savedAchievements);
                    } catch (e) {
                        console.error('Error loading achievements', e);
                    }
                }
                
                // Mark achievements as unlocked based on loaded data
                if (achievements.unlockedAchievements) {
                    achievementsList.forEach(a => {
                        if (achievements.unlockedAchievements.includes(a.id)) {
                            a.unlocked = true;
                        }
                    });
                } else {
                    achievements.unlockedAchievements = [];
                }
                
                // Populate the achievements grid
                renderAchievements();
                updateAchievementStats();
            }
            
            // Render all achievements to the achievements grid
            function renderAchievements() {
                const grid = document.getElementById('achievements-grid');
                grid.innerHTML = '';
                
                achievementsList.forEach(achievement => {
                    const progress = achievement.progressFn ? 
                        Math.min(achievement.progressFn() / achievement.requirement, 1) : 
                        (achievement.unlocked ? 1 : 0);
                    
                    const card = document.createElement('div');
                    card.className = `achievement-card ${achievement.unlocked ? 'unlocked' : 'locked'}`;
                    card.setAttribute('data-id', achievement.id);
                    
                    card.innerHTML = `
                        <div class="achievement-header">
                            <div class="achievement-icon">
                                <i class="fas ${achievement.icon}"></i>
                            </div>
                            <div class="achievement-name">${achievement.name}</div>
                        </div>
                        <div class="achievement-description">${achievement.description}</div>
                        <div class="achievement-progress-container">
                            <div class="achievement-progress" style="width: ${progress * 100}%"></div>
                        </div>
                        <div class="achievement-completed">Completed!</div>
                    `;
                    
                    grid.appendChild(card);
                });
            }
            
            // Update the achievement statistics
            function updateAchievementStats() {
                const totalAchievements = achievementsList.length;
                const unlockedCount = achievements.unlockedAchievements.length;
                const percentage = Math.round((unlockedCount / totalAchievements) * 100);
                
                document.getElementById('achievements-total').textContent = totalAchievements;
                document.getElementById('achievements-unlocked').textContent = unlockedCount;
                document.getElementById('achievements-percentage').textContent = percentage + '%';
            }
            
            // Check if any achievements have been unlocked
            function checkAchievements() {
                let newlyUnlocked = [];
                
                achievementsList.forEach(achievement => {
                    if (!achievement.unlocked) {
                        if (achievement.special) {
                            // Special achievements are handled separately
                            return;
                        }
                        
                        const currentProgress = achievement.progressFn ? achievement.progressFn() : 0;
                        
                        if (currentProgress >= achievement.requirement) {
                            achievement.unlocked = true;
                            achievements.unlockedAchievements.push(achievement.id);
                            newlyUnlocked.push(achievement);
                        }
                    }
                });
                
                // Save achievements progress
                saveAchievements();
                
                // Update UI if any achievements were unlocked
                if (newlyUnlocked.length > 0) {
                    renderAchievements();
                    updateAchievementStats();
                    
                    // Show notification for the last unlocked achievement
                    showAchievementNotification(newlyUnlocked[newlyUnlocked.length - 1]);
                }
            }
            
            // Unlock a special achievement
            function unlockSpecialAchievement(id) {
                const achievement = achievementsList.find(a => a.id === id);
                if (achievement && !achievement.unlocked) {
                    achievement.unlocked = true;
                    achievements.unlockedAchievements.push(id);
                    
                    // Save and update UI
                    saveAchievements();
                    renderAchievements();
                    updateAchievementStats();
                    
                    // Show notification
                    showAchievementNotification(achievement);
                }
            }
            
            // Show achievement notification
            function showAchievementNotification(achievement) {
                // Play achievement sound
                playSound('achievement');
                
                // Create notification element
                const notification = document.createElement('div');
                notification.className = 'achievement-notification';
                notification.innerHTML = `
                    <div class="achievement-notification-icon">
                        <i class="fas ${achievement.icon}"></i>
                    </div>
                    <div class="achievement-notification-content">
                        <h4>Achievement Unlocked!</h4>
                        <p>${achievement.name}</p>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                // Remove notification after animation completes
                setTimeout(() => {
                    notification.remove();
                }, 5000);
            }
            
            // Save achievements to localStorage
            function saveAchievements() {
                localStorage.setItem('achievements', JSON.stringify(achievements));
            }
            
            // Initialize grid
            createGrid();
            refreshInventory();
            
            // Initialize build slots
            initializeBuildSlots();
            
            // Load and apply saved settings
            loadSettings();
            
            // Start auto-save if enabled
            startAutoSave();
            
            // Start block effects timer
            startBlockEffects();
            
            // Initialize achievements
            initializeAchievements();
            
            // Initialize shop price indicators
            updateShopPriceIndicators();
            
            // Player profile functionality
            
            // Player profile variables
            let bonusClicks = 0;
            let playTime = 0;
            let playTimeInterval;
            
            // Player profile data
            let playerProfile = {
                name: "Player",
                avatar: "user-circle",
                accentColor: "#4682ff",
                title: "Beginner",
                level: 1,
                xp: 0,
                xpForNextLevel: 1000,
                lastSave: Date.now()
            };
            
            // Initialize player profile
            function initializeProfile() {
                // Check localStorage for saved profile
                const savedProfile = localStorage.getItem('playerProfile');
                if (savedProfile) {
                    try {
                        playerProfile = JSON.parse(savedProfile);
                    } catch (e) {
                        console.error('Error loading player profile', e);
                    }
                }
                
                // Update UI with profile data
                updateProfileUI();
                
                // Start tracking play time
                startPlayTimeTracking();
                
                // Set up event listeners for profile interactions
                setupProfileEventListeners();
            }
            
            // Start tracking play time
            function startPlayTimeTracking() {
                // Clear any existing interval
                if (playTimeInterval) {
                    clearInterval(playTimeInterval);
                }
                
                // Update play time every minute
                playTimeInterval = setInterval(function() {
                    playTime += 60; // Add 60 seconds
                    updatePlayTimeDisplay();
                    
                    // Award XP for play time (1 XP per minute)
                    awardXP(1);
                }, 60000); // Every minute
            }
            
            // Award XP to the player
            function awardXP(amount) {
                playerProfile.xp += amount;
                
                // Check for level up
                if (playerProfile.xp >= playerProfile.xpForNextLevel) {
                    levelUp();
                }
                
                // Update UI
                updateLevelProgress();
                
                // Save profile
                saveProfile();
            }
            
            // Level up the player
            function levelUp() {
                playerProfile.level++;
                
                // Calculate XP for next level (increasing by 25% each level)
                const xpRemaining = playerProfile.xp - playerProfile.xpForNextLevel;
                playerProfile.xpForNextLevel = Math.round(playerProfile.xpForNextLevel * 1.25);
                playerProfile.xp = xpRemaining;
                
                // Award score bonus for leveling up
                const levelBonus = playerProfile.level * 100;
                incrementScore(levelBonus);
                
                // Show level up notification
                const notification = document.createElement('div');
                notification.className = 'achievement-notification';
                notification.innerHTML = `
                    <div class="achievement-notification-icon">
                        <i class="fas fa-arrow-up"></i>
                    </div>
                    <div class="achievement-notification-content">
                        <h4>Level Up!</h4>
                        <p>You reached level ${playerProfile.level}! +${levelBonus} score bonus</p>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                // Remove notification after animation completes
                setTimeout(() => {
                    notification.remove();
                }, 5000);
                
                // Unlock new title at specific levels
                if (playerProfile.level === 5) {
                    unlockTitle("Bronze Builder");
                } else if (playerProfile.level === 10) {
                    unlockTitle("Silver Architect");
                } else if (playerProfile.level === 15) {
                    unlockTitle("Gold Constructor");
                } else if (playerProfile.level === 20) {
                    unlockTitle("Diamond Designer");
                }
                
                // Update UI
                updateProfileUI();
            }
            
            // Unlock a new player title
            function unlockTitle(title) {
                // Create a new option element
                const titleOption = document.createElement('option');
                titleOption.value = title;
                titleOption.textContent = title;
                
                // Add to the select element
                document.getElementById('player-title').appendChild(titleOption);
                
                // Show notification
                const notification = document.createElement('div');
                notification.className = 'achievement-notification';
                notification.innerHTML = `
                    <div class="achievement-notification-icon">
                        <i class="fas fa-crown"></i>
                    </div>
                    <div class="achievement-notification-content">
                        <h4>New Title Unlocked!</h4>
                        <p>${title}</p>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                // Remove notification after animation completes
                setTimeout(() => {
                    notification.remove();
                }, 5000);
            }
            
            // Update level progress display
            function updateLevelProgress() {
                // Calculate progress percentage
                const progressPercent = (playerProfile.xp / playerProfile.xpForNextLevel) * 100;
                
                // Update the progress bar
                document.querySelector('.level-progress').style.width = `${progressPercent}%`;
                
                // Update level number
                document.querySelector('.level-number').textContent = playerProfile.level;
                
                // Update XP text
                document.querySelector('.current-xp').textContent = playerProfile.xp;
                document.querySelector('.next-level-xp').textContent = playerProfile.xpForNextLevel;
            }
            
            // Update play time display
            function updatePlayTimeDisplay() {
                // Calculate hours and minutes
                const hours = Math.floor(playTime / 3600);
                const minutes = Math.floor((playTime % 3600) / 60);
                
                // Update display
                document.getElementById('profile-play-time').textContent = `${hours}h ${minutes}m`;
            }
            
            // Update profile UI with current data
            function updateProfileUI() {
                // Set player name
                document.querySelector('.profile-name').innerHTML = `${playerProfile.name} <i class="fas fa-pencil-alt edit-name-btn"></i>`;
                
                // Set avatar
                document.querySelector('.avatar-image i').className = `fas fa-${playerProfile.avatar}`;
                
                // Set title
                document.querySelector('.profile-title').textContent = playerProfile.title;
                
                // Set level and XP
                document.querySelector('.level-number').textContent = playerProfile.level;
                document.querySelector('.current-xp').textContent = playerProfile.xp;
                document.querySelector('.next-level-xp').textContent = playerProfile.xpForNextLevel;
                
                // Set level progress
                const progressPercent = (playerProfile.xp / playerProfile.xpForNextLevel) * 100;
                document.querySelector('.level-progress').style.width = `${progressPercent}%`;
                
                // Set theme color
                document.documentElement.style.setProperty('--accent-color', playerProfile.accentColor);
                
                // Update selected avatar
                document.querySelectorAll('.avatar-option').forEach(option => {
                    option.classList.remove('selected');
                    if (option.getAttribute('data-avatar') === playerProfile.avatar) {
                        option.classList.add('selected');
                    }
                });
                
                // Update selected color
                document.querySelectorAll('.color-option').forEach(option => {
                    option.classList.remove('selected');
                    if (option.getAttribute('data-color') === playerProfile.accentColor) {
                        option.classList.add('selected');
                    }
                });
                
                // Update selected title
                document.getElementById('player-title').value = playerProfile.title;
                
                // Update game statistics
                document.getElementById('profile-total-score').textContent = score;
                document.getElementById('profile-total-clicks').textContent = achievements.clickCount;
                document.getElementById('profile-best-cps').textContent = bestCps.toFixed(1);
                document.getElementById('profile-blocks-placed').textContent = achievements.blocksPlaced;
                document.getElementById('profile-blocks-removed').textContent = achievements.blocksRemoved;
                updatePlayTimeDisplay();
                
                // Update achievements progress
                const totalAchievements = achievementsList.length;
                const unlockedAchievements = achievements.unlockedAchievements.length;
                const achievementPercent = (unlockedAchievements / totalAchievements) * 100;
                
                document.querySelector('.achievement-progress').style.width = `${achievementPercent}%`;
                document.getElementById('profile-achievements-count').textContent = unlockedAchievements;
                document.getElementById('profile-achievements-total').textContent = totalAchievements;
                
                // Update recent achievements
                updateRecentAchievements();
                
                // Update block distribution chart
                updateBlockDistributionChart();
            }
            
            // Update recent achievements display
            function updateRecentAchievements() {
                const recentList = document.getElementById('recent-achievements-list');
                
                // If no achievements yet, show empty message
                if (achievements.unlockedAchievements.length === 0) {
                    recentList.innerHTML = `<div class="empty-achievements">No achievements yet. Keep playing!</div>`;
                    return;
                }
                
                // Get the 3 most recent achievements
                const recentAchievements = [];
                for (let i = achievements.unlockedAchievements.length - 1; i >= 0 && recentAchievements.length < 3; i--) {
                    const achievementId = achievements.unlockedAchievements[i];
                    const achievement = achievementsList.find(a => a.id === achievementId);
                    if (achievement) {
                        recentAchievements.push(achievement);
                    }
                }
                
                // Create HTML for recent achievements
                let html = '';
                recentAchievements.forEach(achievement => {
                    html += `
                        <div class="recent-achievement">
                            <div class="recent-achievement-icon">
                                <i class="fas ${achievement.icon}"></i>
                            </div>
                            <div class="recent-achievement-info">
                                <div class="recent-achievement-name">${achievement.name}</div>
                                <div class="recent-achievement-desc">${achievement.description}</div>
                            </div>
                        </div>
                    `;
                });
                
                recentList.innerHTML = html;
            }
            
            // Update block distribution chart
            function updateBlockDistributionChart() {
                const chart = document.getElementById('block-distribution-chart');
                
                // Calculate percentages
                const total = achievements.redBlocks + achievements.blueBlocks + achievements.goldBlocks + 
                              achievements.purpleBlocks + achievements.greenBlocks + achievements.blackBlocks;
                
                // If no blocks placed yet, show empty state
                if (total === 0) {
                    chart.innerHTML = `<div class="empty-chart">No blocks placed yet</div>`;
                    return;
                }
                
                // Create bar for each block type
                const redPercent = (achievements.redBlocks / total) * 100;
                const bluePercent = (achievements.blueBlocks / total) * 100;
                const goldPercent = (achievements.goldBlocks / total) * 100;
                const purplePercent = (achievements.purpleBlocks / total) * 100;
                const greenPercent = (achievements.greenBlocks / total) * 100;
                const blackPercent = (achievements.blackBlocks / total) * 100;
                
                // Create HTML for the chart
                chart.innerHTML = `
                    <div class="distribution-bar" style="height: ${redPercent}%; background-color: rgba(255, 62, 62, 0.7);">
                        <div class="bar-value">${achievements.redBlocks}</div>
                    </div>
                    <div class="distribution-bar" style="height: ${bluePercent}%; background-color: rgba(0, 238, 255, 0.7);">
                        <div class="bar-value">${achievements.blueBlocks}</div>
                    </div>
                    <div class="distribution-bar" style="height: ${goldPercent}%; background-color: rgba(255, 215, 0, 0.7);">
                        <div class="bar-value">${achievements.goldBlocks}</div>
                    </div>
                    <div class="distribution-bar" style="height: ${purplePercent}%; background-color: rgba(138, 43, 226, 0.7);">
                        <div class="bar-value">${achievements.purpleBlocks}</div>
                    </div>
                    <div class="distribution-bar" style="height: ${greenPercent}%; background-color: rgba(50, 205, 50, 0.7);">
                        <div class="bar-value">${achievements.greenBlocks}</div>
                    </div>
                    <div class="distribution-bar" style="height: ${blackPercent}%; background-color: rgba(51, 51, 51, 0.7);">
                        <div class="bar-value">${achievements.blackBlocks}</div>
                    </div>
                `;
            }
            
            // Set up event listeners for profile interactions
            function setupProfileEventListeners() {
                // Edit name button
                document.querySelector('.edit-name-btn').addEventListener('click', function() {
                    const modal = document.getElementById('change-name-modal');
                    modal.style.display = 'flex';
                    
                    // Set current name as default
                    document.getElementById('new-player-name').value = playerProfile.name;
                    
                    // Focus the input
                    setTimeout(() => {
                        document.getElementById('new-player-name').focus();
                    }, 100);
                });
                
                // Close modal button
                const closeButtons = document.querySelectorAll('.profile-modal-close, .profile-btn-cancel');
                closeButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        document.getElementById('change-name-modal').style.display = 'none';
                    });
                });
                
                // Save name button
                document.getElementById('save-player-name').addEventListener('click', function() {
                    const newName = document.getElementById('new-player-name').value.trim();
                    
                    if (newName.length >= 3 && newName.length <= 20) {
                        playerProfile.name = newName;
                        updateProfileUI();
                        saveProfile();
                        document.getElementById('change-name-modal').style.display = 'none';
                    } else {
                        // Show validation error
                        document.querySelector('.profile-input-hint').style.color = '#ff3e3e';
                    }
                });
                
                // Avatar selection
                document.querySelectorAll('.avatar-option').forEach(option => {
                    option.addEventListener('click', function() {
                        const avatar = this.getAttribute('data-avatar');
                        
                        // Update selected state
                        document.querySelectorAll('.avatar-option').forEach(opt => {
                            opt.classList.remove('selected');
                        });
                        this.classList.add('selected');
                        
                        // Update profile
                        playerProfile.avatar = avatar;
                        
                        // Update UI
                        document.querySelector('.avatar-image i').className = `fas fa-${avatar}`;
                        
                        // Award XP for customization
                        awardXP(2);
                        
                        // Save profile
                        saveProfile();
                    });
                });
                
                // Color options
                document.querySelectorAll('.color-option').forEach(option => {
                    option.addEventListener('click', function() {
                        const color = this.getAttribute('data-color');
                        
                        // Update selected state
                        document.querySelectorAll('.color-option').forEach(opt => {
                            opt.classList.remove('selected');
                        });
                        this.classList.add('selected');
                        
                        // Update profile
                        playerProfile.accentColor = color;
                        
                        // Update CSS variable
                        document.documentElement.style.setProperty('--accent-color', color);
                        
                        // Award XP for customization
                        awardXP(2);
                        
                        // Save profile
                        saveProfile();
                    });
                });
                
                // Title selection
                const titleSelector = document.getElementById('player-title');
                if (titleSelector) {
                    titleSelector.addEventListener('change', function() {
                        playerProfile.title = this.value;
                        
                        // Award XP for customization
                        awardXP(3);
                        
                        // Save profile
                        saveProfile();
                    });
                }
                
                // View all achievements button
                const viewAllAchievements = document.getElementById('view-all-achievements');
                if (viewAllAchievements) {
                    viewAllAchievements.addEventListener('click', function() {
                        // Switch to achievements section
                        showSection('achievements');
                        
                        // Update active menu item
                        document.querySelectorAll('.menu-item').forEach(item => {
                            item.classList.remove('active');
                            if (item.getAttribute('data-section') === 'achievements') {
                                item.classList.add('active');
                            }
                        });
                    });
                }
                
                // Save profile button
                const saveProfileBtn = document.getElementById('save-profile');
                if (saveProfileBtn) {
                    saveProfileBtn.addEventListener('click', function() {
                        saveProfile();
                        
                        // Show confirmation message
                        const confirmationMessage = document.createElement('div');
                        confirmationMessage.className = 'auto-save-indicator';
                        confirmationMessage.innerHTML = '<i class="fas fa-check-circle"></i> Profile saved!';
                        document.body.appendChild(confirmationMessage);
                        
                        setTimeout(() => {
                            confirmationMessage.remove();
                        }, 2000);
                    });
                }
                
                // Reset profile button
                const resetProfileBtn = document.getElementById('reset-profile');
                if (resetProfileBtn) {
                    resetProfileBtn.addEventListener('click', function() {
                        const confirm = window.confirm('Are you sure you want to reset your profile? This will not affect your game progress or achievements.');
                        
                        if (confirm) {
                            // Reset to defaults
                            playerProfile = {
                                name: "Player",
                                avatar: "user-circle",
                                accentColor: "#4682ff",
                                title: "Beginner",
                                level: 1,
                                xp: 0,
                                xpForNextLevel: 1000,
                                lastSave: Date.now()
                            };
                            
                            // Update UI
                            updateProfileUI();
                            
                            // Save changes
                            saveProfile();
                        }
                    });
                }
            }
            
            // Save profile to localStorage
            function saveProfile() {
                // Update last save time
                playerProfile.lastSave = Date.now();
                
                try {
                    localStorage.setItem('playerProfile', JSON.stringify(playerProfile));
                    
                    // Show save confirmation
                    const saveIndicator = document.createElement('div');
                    saveIndicator.className = 'auto-save-indicator';
                    saveIndicator.innerHTML = '<i class="fas fa-check-circle"></i> Profile saved';
                    document.body.appendChild(saveIndicator);
                    
                    setTimeout(() => {
                        saveIndicator.remove();
                    }, 2000);
                    
                } catch (e) {
                    console.error('Error saving profile:', e);
                }
            }
            
            // Modify generateSaveData to include profile data
            const originalGenerateSaveData = generateSaveData;
            generateSaveData = function() {
                // Get the original save data
                const gameData = JSON.parse(atob(originalGenerateSaveData()));
                
                // Add profile data
                gameData.playerProfile = playerProfile;
                gameData.bonusClicks = bonusClicks;
                gameData.playTime = playTime;
                
                // Convert to JSON and Base64 encode
                const jsonString = JSON.stringify(gameData);
                return btoa(jsonString);
            };
            
            // Modify loadSaveData to load profile data
            const originalLoadSaveData = loadSaveData;
            loadSaveData = function(saveCode) {
                try {
                    // Decode from Base64 and parse JSON
                    const jsonString = atob(saveCode);
                    const gameData = JSON.parse(jsonString);
                    
                    // Load profile data if available
                    if (gameData.playerProfile) {
                        playerProfile = gameData.playerProfile;
                    }
                    
                    if (typeof gameData.bonusClicks !== 'undefined') {
                        bonusClicks = gameData.bonusClicks;
                    }
                    
                    if (typeof gameData.playTime !== 'undefined') {
                        playTime = gameData.playTime;
                    }
                    
                    // Call original function
                    const result = originalLoadSaveData(saveCode);
                    
                    // Update profile UI
                    updateProfileUI();
                    
                    return result;
                } catch (e) {
                    console.error('Error loading save data:', e);
                    return originalLoadSaveData(saveCode);
                }
            };
            
            // Initialize player profile
            initializeProfile();
        });
    </script>
</body>
</html> 